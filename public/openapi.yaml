openapi: 3.1.0
info:
  title: Lune API
  version: 0.2.0
  description: >
    API publique (landing + auth) et API app interne (PRO / PERSO / PERFORMANCE).
    Cette version couvre l'auth, la santé, les entreprises PRO, les invitations,
    les clients, les prospects et les projets.

servers:
  - url: http://localhost:3000
    description: Développement local
  - url: https://diwanbg.work
    description: Production (Railway)

tags:
  - name: Health
    description: Vérification de l'état de l'API
  - name: Auth
    description: Authentification et profil utilisateur
  - name: Pro / Business
    description: Entreprises PRO et memberships
  - name: Pro / Invites
    description: Invitations à rejoindre une entreprise PRO
  - name: Pro / Clients
    description: Clients d'une entreprise PRO
  - name: Pro / Prospects
    description: Prospects commerciaux et pipeline
  - name: Pro / Projects
    description: Projets liés à une entreprise PRO

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Vérifie la connexion à la base
      responses:
        '200':
          description: Base joignable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Crée un utilisateur et émet un cookie de session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Utilisateur créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '409':
          description: Conflit (email déjà utilisé)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Authentifie l'utilisateur et émet un cookie de session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Authentification réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Identifiants invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Déconnecte l'utilisateur (supprime le cookie)
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Déconnexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: logged_out

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Retourne l'utilisateur courant (session active)
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Utilisateur authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses:
    get:
      tags: [Pro / Business]
      summary: Liste les entreprises liées à l'utilisateur courant
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Liste des entreprises
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessListResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Pro / Business]
      summary: Crée une nouvelle entreprise pour l'utilisateur (OWNER)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BusinessCreateRequest'
      responses:
        '201':
          description: Entreprise créée + rôle de l'utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessMembershipSummary'
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}:
    get:
      tags: [Pro / Business]
      summary: Récupère une entreprise spécifique (si membre)
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
          description: Identifiant interne de l'entreprise (BigInt sérialisé)
      responses:
        '200':
          description: Détails de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Business'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Entreprise introuvable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}/invites:
    get:
      tags: [Pro / Invites]
      summary: Liste les invitations d'une entreprise (admin / owner uniquement)
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
          description: Identifiant interne de l'entreprise
      responses:
        '200':
          description: Liste des invitations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessInviteListResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Droit insuffisant (non admin/owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Pro / Invites]
      summary: Crée une invitation pour rejoindre l'entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
          description: Identifiant interne de l'entreprise
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BusinessInviteCreateRequest'
      responses:
        '201':
          description: Invitation créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessInvite'
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Droit insuffisant (non admin/owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}/invites/{inviteId}:
    delete:
      tags: [Pro / Invites]
      summary: Révoque une invitation existante
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
        - name: inviteId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Invitation révoquée
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Droit insuffisant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invitation introuvable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/invites/accept:
    post:
      tags: [Pro / Invites]
      summary: Accepte une invitation via un token
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BusinessInviteAcceptRequest'
      responses:
        '200':
          description: Invitation acceptée, membership créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessInviteAcceptResponse'
        '400':
          description: Token invalide ou invitation non valide/expirée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}/clients:
    get:
      tags: [Pro / Clients]
      summary: Liste les clients d'une entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Filtre par nom (recherche partielle, insensible à la casse)
      responses:
        '200':
          description: Liste des clients
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientListResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Pro / Clients]
      summary: Crée un client pour une entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClientCreateRequest'
      responses:
        '201':
          description: Client créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Client'
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}/prospects:
    get:
      tags: [Pro / Prospects]
      summary: Liste les prospects d'une entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
          description: Identifiant de l'entreprise (BigInt sérialisé)
        - name: search
          in: query
          required: false
          schema:
            type: string
          description: Filtre par nom du prospect
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ProspectPipelineStatus'
          description: Filtre par statut dans le pipeline
      responses:
        '200':
          description: Liste des prospects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProspectListResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Pro / Prospects]
      summary: Crée un prospect
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
          description: Identifiant de l'entreprise (BigInt sérialisé)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProspectCreateRequest'
      responses:
        '201':
          description: Prospect créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prospect'
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/pro/businesses/{businessId}/projects:
    get:
      tags: [Pro / Projects]
      summary: Liste les projets d'une entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
        - name: status
          in: query
          required: false
          schema:
            $ref: '#/components/schemas/ProjectStatus'
          description: Filtre par statut du projet
      responses:
        '200':
          description: Liste des projets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectListResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags: [Pro / Projects]
      summary: Crée un projet pour une entreprise
      security:
        - cookieAuth: []
      parameters:
        - name: businessId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreateRequest'
      responses:
        '201':
          description: Projet créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'
        '400':
          description: Données invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Non authentifié
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Non membre de l'entreprise
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token

  schemas:
    # --- Auth & user ---
    User:
      type: object
      properties:
        id:
          type: string
          description: Identifiant interne (BigInt sérialisé)
        email:
          type: string
          format: email
        name:
          type: string
          nullable: true
        role:
          type: string
          enum: [USER, ADMIN]
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        name:
          type: string
          nullable: true

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    MeResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        memberships:
          type: array
          description: >
            Pour l'instant, renvoyé vide (les entreprises viennent de /api/pro/businesses).
          items:
            $ref: '#/components/schemas/BusinessMembershipSummary'

    # --- Business / PRO ---
    BusinessRole:
      type: string
      enum: [OWNER, ADMIN, MEMBER, VIEWER]

    Business:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        ownerId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BusinessCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Nom de l'entreprise

    BusinessMembershipSummary:
      type: object
      properties:
        business:
          $ref: '#/components/schemas/Business'
        role:
          $ref: '#/components/schemas/BusinessRole'

    BusinessListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/BusinessMembershipSummary'

    # --- Invites ---
    BusinessInviteStatus:
      type: string
      enum: [PENDING, ACCEPTED, REVOKED]

    BusinessInvite:
      type: object
      properties:
        id:
          type: string
        businessId:
          type: string
        email:
          type: string
          format: email
        role:
          $ref: '#/components/schemas/BusinessRole'
        status:
          $ref: '#/components/schemas/BusinessInviteStatus'
        token:
          type: string
          description: Token d'invitation (peut être utilisé dans l'URL d'acceptation)
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
          nullable: true

    BusinessInviteListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/BusinessInvite'

    BusinessInviteCreateRequest:
      type: object
      required: [email, role]
      properties:
        email:
          type: string
          format: email
        role:
          $ref: '#/components/schemas/BusinessRole'

    BusinessInviteAcceptRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
          description: Token reçu par email

    BusinessInviteAcceptResponse:
      type: object
      properties:
        business:
          $ref: '#/components/schemas/Business'
        role:
          $ref: '#/components/schemas/BusinessRole'

    # --- Clients ---
    Client:
      type: object
      properties:
        id:
          type: string
        businessId:
          type: string
        name:
          type: string
        email:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ClientCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        email:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true

    ClientListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Client'

    # --- Prospects ---
    Prospect:
      type: object
      properties:
        id:
          type: string
        businessId:
          type: string
        name:
          type: string
        contactName:
          type: string
          nullable: true
        contactEmail:
          type: string
          format: email
          nullable: true
        contactPhone:
          type: string
          nullable: true
        source:
          $ref: '#/components/schemas/LeadSource'
        interestNote:
          type: string
          nullable: true
        qualificationLevel:
          $ref: '#/components/schemas/QualificationLevel'
        projectIdea:
          type: string
          nullable: true
        estimatedBudget:
          type: integer
          format: int32
          nullable: true
        firstContactAt:
          type: string
          format: date-time
          nullable: true
        pipelineStatus:
          $ref: '#/components/schemas/ProspectPipelineStatus'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProspectCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        contactName:
          type: string
          nullable: true
        contactEmail:
          type: string
          format: email
          nullable: true
        contactPhone:
          type: string
          nullable: true
        source:
          $ref: '#/components/schemas/LeadSource'
        interestNote:
          type: string
          nullable: true
        qualificationLevel:
          $ref: '#/components/schemas/QualificationLevel'
        projectIdea:
          type: string
          nullable: true
        estimatedBudget:
          type: integer
          format: int32
          nullable: true
        firstContactAt:
          type: string
          format: date-time
          nullable: true
        pipelineStatus:
          $ref: '#/components/schemas/ProspectPipelineStatus'

    ProspectListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Prospect'

    LeadSource:
      type: string
      enum:
        - UNKNOWN
        - OUTBOUND
        - INBOUND
        - REFERRAL
        - OTHER

    QualificationLevel:
      type: string
      enum:
        - COLD
        - WARM
        - HOT

    ProspectPipelineStatus:
      type: string
      enum:
        - NEW
        - IN_DISCUSSION
        - OFFER_SENT
        - FOLLOW_UP
        - CLOSED

    # --- Projects ---
    ProjectStatus:
      type: string
      enum: [PLANNED, ACTIVE, ON_HOLD, COMPLETED, CANCELLED]

    Project:
      type: object
      properties:
        id:
          type: string
        businessId:
          type: string
        clientId:
          type: string
          nullable: true
        clientName:
          type: string
          nullable: true
          description: Nom du client (convenance pour les listes)
        name:
          type: string
        status:
          $ref: '#/components/schemas/ProjectStatus'
        startDate:
          type: string
          format: date-time
          nullable: true
        endDate:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProjectCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        clientId:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/ProjectStatus'
        startDate:
          type: string
          format: date-time
          nullable: true
        endDate:
          type: string
          format: date-time
          nullable: true

    ProjectListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Project'

    # --- Misc ---
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        reason:
          type: string
          nullable: true
