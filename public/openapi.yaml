openapi: 3.1.0
info:
  title: Lune API
  version: 0.3.0
  description: >
    API publique (auth, santé) et API app (PERSONAL / PRO). Toutes les IDs BigInt sont sérialisées en string.
    Toutes les réponses mutables exigent CSRF (Origin) et renvoient `x-request-id` + `cache-control: no-store`.
servers:
  - url: http://localhost:3000
    description: Développement local
  - url: https://diwanbg.work
    description: Production (Railway)
security:
  - cookieAuth: []
tags:
  - name: Health
  - name: Auth
  - name: Account
  - name: Personal
  - name: Pro / Business
  - name: Pro / Clients
  - name: Pro / Prospects
  - name: Pro / Projects
  - name: Pro / Services
  - name: Pro / Tasks
  - name: Pro / Processes
  - name: Pro / Interactions
  - name: Pro / Members
  - name: Pro / Invites
  - name: Pro / Finances
  - name: Pro / Stock
  - name: Pro / Billing
  - name: Pro / References
  - name: Pro / Settings
  - name: Pro / Finance Advanced

paths:
  /api/health:
    get:
      tags: [Health]
      summary: Vérifie la connexion DB
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Crée un utilisateur et émet le cookie
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        '201':
          description: Utilisateur créé
          content:
            application/json:
              schema:
                type: object
                properties: { user: { $ref: '#/components/schemas/User' } }
        '409': { $ref: '#/components/responses/Error' }
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Authentifie et émet un cookie
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200':
          description: Auth OK
          content:
            application/json:
              schema:
                type: object
                properties: { user: { $ref: '#/components/schemas/User' } }
        '401': { $ref: '#/components/responses/Error' }
  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Supprime le cookie
      security: [ { cookieAuth: [] } ]
      responses:
        '200':
          description: Déconnecté
          content:
            application/json:
              schema:
                type: object
                properties: { status: { type: string, example: logged_out } }
  /api/auth/me:
    get:
      tags: [Auth]
      summary: Retourne l'utilisateur courant
      security: [ { cookieAuth: [] } ]
      responses:
        '200':
          description: Utilisateur authentifié
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Error' }

  /api/account/profile:
    patch:
      tags: [Account]
      summary: Met à jour le profil (nom/email)
      security: [ { cookieAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                firstName: { type: string, nullable: true }
                lastName: { type: string, nullable: true }
      responses:
        '200':
          description: Profil mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '401': { $ref: '#/components/responses/Error' }
  /api/account/password:
    patch:
      tags: [Account]
      summary: Change le mot de passe
      security: [ { cookieAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [currentPassword, newPassword]
              properties:
                currentPassword: { type: string }
                newPassword: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
        '400': { $ref: '#/components/responses/Error' }
  /api/account/preferences:
    get:
      tags: [Account]
      security: [ { cookieAuth: [] } ]
      summary: Lit les préférences (langue, thème)
      responses:
        '200':
          description: Préférences
          content:
            application/json:
              schema:
                type: object
                properties:
                  language: { type: string, enum: [fr, en] }
                  theme: { type: string, enum: [light, dark, system] }
    patch:
      tags: [Account]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour les préférences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                language: { type: string, enum: [fr, en] }
                theme: { type: string, enum: [light, dark, system] }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/personal/accounts:
    get:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Liste des comptes personnels
      responses:
        '200':
          description: Liste
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/PersonalAccount' }
    post:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Crée un compte personnel
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, type]
              properties:
                name: { type: string }
                type: { type: string, enum: [CHECKING, SAVINGS, CASH] }
      responses:
        '201':
          description: Créé
          content:
            application/json:
              schema:
                type: object
                properties: { account: { $ref: '#/components/schemas/PersonalAccount' } }
  /api/personal/accounts/{accountId}:
    get:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Détail compte personnel
      parameters:
        - $ref: '#/components/parameters/AccountId'
      responses:
        '200':
          description: Compte
          content:
            application/json:
              schema:
                type: object
                properties: { account: { $ref: '#/components/schemas/PersonalAccountDetail' } }
        '404': { $ref: '#/components/responses/Error' }
  /api/personal/categories:
    get:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Liste des catégories perso
      responses:
        '200':
          description: Liste
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        name: { type: string }
  /api/personal/summary:
    get:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Synthèse finances perso
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/personal/transactions:
    get:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Liste paginée des transactions
      parameters:
        - in: query
          name: limit
          schema: { type: integer, default: 50 }
      responses:
        '200':
          description: Liste
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/PersonalTransaction' }
    post:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Crée une transaction
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PersonalTransactionCreate' }
      responses:
        '201':
          description: Créé
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/PersonalTransaction' } }
  /api/personal/transactions/{transactionId}:
    patch:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une transaction
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PersonalTransactionUpdate' }
      responses:
        '200':
          description: Mis à jour
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/PersonalTransaction' } }
    delete:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une transaction
      parameters:
        - $ref: '#/components/parameters/TransactionId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/personal/transactions/import:
    post:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Import CSV de transactions
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                accountId:
                  type: string
                dryRun:
                  type: string
      responses:
        '200':
          description: Résultat import
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported: { type: integer }
                  invalidRows: { type: integer }
                  errors: { type: array, items: { type: object } }
  /api/personal/transactions/bulk-delete:
    post:
      tags: [Personal]
      security: [ { cookieAuth: [] } ]
      summary: Suppression multiple de transactions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses:
    get:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Liste les businesses de l'utilisateur
      responses:
        '200':
          description: Liste memberships
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        business: { $ref: '#/components/schemas/Business' }
                        role: { $ref: '#/components/schemas/BusinessRole' }
    post:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Crée un business
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name: { type: string }
                websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
      responses:
        '201':
          description: Créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  business: { $ref: '#/components/schemas/Business' }
                  role: { $ref: '#/components/schemas/BusinessRole' }
  /api/pro/businesses/{businessId}:
    get:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Détail business
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200':
          description: Business
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Business' }
    patch:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un business (nom / site)
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
      responses:
        '200':
          description: Business mis à jour
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Business' } }
    delete:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un business (owner)
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/dashboard:
    get:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: KPIs tableau de bord business
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/clients:
    get:
      tags: [Pro / Clients]
      security: [ { cookieAuth: [] } ]
      summary: Liste des clients
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: search
          required: false
          schema: { type: string }
        - in: query
          name: status
          required: false
          schema: { type: string, enum: [ACTIVE, PAUSED, FORMER] }
        - in: query
          name: sector
          required: false
          schema: { type: string }
        - in: query
          name: origin
          required: false
          schema: { type: string }
        - in: query
          name: categoryReferenceId
          required: false
          schema: { type: string }
        - in: query
          name: tagReferenceId
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Liste
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Client' }
    post:
      tags: [Pro / Clients]
      security: [ { cookieAuth: [] } ]
      summary: Crée un client
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientCreate' }
      responses:
        '201':
          description: Client
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Client' }
  /api/pro/businesses/{businessId}/clients/{clientId}:
    get:
      tags: [Pro / Clients]
      security: [ { cookieAuth: [] } ]
      summary: Détail client
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ClientId'
      responses:
        '200':
          description: Client
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Client' } }
    patch:
      tags: [Pro / Clients]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un client
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ClientId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ClientUpdate' }
      responses:
        '200':
          description: Client
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Client' } }

  /api/pro/businesses/{businessId}/prospects:
    get:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Liste des prospects
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Crée un prospect
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProspectCreate' }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/prospects/{prospectId}:
    get:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Détail prospect
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProspectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    patch:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un prospect
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProspectId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProspectUpdate' }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un prospect
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProspectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/prospects/{prospectId}/convert:
    post:
      tags: [Pro / Prospects]
      security: [ { cookieAuth: [] } ]
      summary: Convertit un prospect en client/projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProspectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/projects:
    get:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Liste des projets
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: status
          required: false
          schema: { type: string }
        - in: query
          name: archived
          required: false
          schema: { type: string, enum: ['true', 'false', 'all'] }
        - in: query
          name: clientId
          required: false
          schema: { type: string }
        - in: query
          name: q
          required: false
          schema: { type: string }
        - in: query
          name: categoryReferenceId
          required: false
          schema: { type: string }
        - in: query
          name: tagReferenceId
          required: false
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Crée un projet
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name: { type: string }
                clientId: { type: string, nullable: true }
                categoryReferenceId: { type: string, nullable: true }
                tagReferenceIds:
                  type: array
                  items: { type: string }
                status: { type: string }
                startDate: { type: string, format: date, nullable: true }
                endDate: { type: string, format: date, nullable: true }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}:
    get:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Détail projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Projet
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Project' } }
    patch:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProjectUpdate' }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}/services:
    get:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Liste des services associés au projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Ajoute un service au projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [serviceId]
              properties:
                serviceId: { type: string }
                quantity: { type: integer, minimum: 1 }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}/services/{itemId}:
    patch:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un service projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
        - name: itemId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                quantity: { type: integer }
                priceCents: { type: integer }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un service projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
        - name: itemId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}/pricing:
    get:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Calcule le pricing du projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Pricing
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalCents: { type: string }
                  depositCents: { type: string }
                  balanceCents: { type: string }
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        serviceId: { type: string, nullable: true }
                        label: { type: string }
                        quantity: { type: integer }
                        unitPriceCents: { type: string }
                        totalCents: { type: string }
  /api/pro/businesses/{businessId}/projects/{projectId}/quotes:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Liste des devis du projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Crée un devis depuis le pricing projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '201':
          description: Devis créé
          content:
            application/json:
              schema:
                type: object
                properties: { quote: { $ref: '#/components/schemas/Quote' } }
  /api/pro/businesses/{businessId}/projects/{projectId}/invoices:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Liste des factures du projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/projects/{projectId}/archive:
    post:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Archive le projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}/start:
    post:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Démarre le projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/projects/{projectId}/unarchive:
    post:
      tags: [Pro / Projects]
      security: [ { cookieAuth: [] } ]
      summary: Désarchive le projet
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/quotes/{quoteId}:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Détail devis
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/QuoteId'
      responses:
        '200':
          description: Devis
          content:
            application/json:
              schema:
                type: object
                properties: { quote: { $ref: '#/components/schemas/Quote' } }
    patch:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour le statut du devis
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/QuoteId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [DRAFT, SENT, SIGNED, CANCELLED, EXPIRED]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/quotes/{quoteId}/pdf:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Télécharge le PDF du devis
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/QuoteId'
      responses:
        '200':
          description: PDF
          content:
            application/pdf:
              schema:
                type: string
                format: binary
  /api/pro/businesses/{businessId}/quotes/{quoteId}/invoices:
    post:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Crée une facture depuis un devis signé
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/QuoteId'
      responses:
        '201':
          description: Facture
          content:
            application/json:
              schema:
                type: object
                properties: { invoice: { $ref: '#/components/schemas/Invoice' } }
  /api/pro/businesses/{businessId}/invoices/{invoiceId}:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Détail facture
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: Facture
          content:
            application/json:
              schema:
                type: object
                properties: { invoice: { $ref: '#/components/schemas/Invoice' } }
    patch:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour le statut de facture (SENT réserve le stock, PAID le consomme) et peut lier des produits aux lignes
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/InvoiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [DRAFT, SENT, PAID, CANCELLED]
                items:
                  type: array
                  description: Mise à jour des productId des lignes
                  items:
                    type: object
                    properties:
                      id: { type: string }
                      productId: { type: string, nullable: true }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/invoices/{invoiceId}/pdf:
    get:
      tags: [Pro / Billing]
      security: [ { cookieAuth: [] } ]
      summary: Télécharge le PDF facture
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/InvoiceId'
      responses:
        '200':
          description: PDF
          content:
            application/pdf:
              schema:
                type: string
                format: binary

  /api/pro/businesses/{businessId}/tasks:
    get:
      tags: [Pro / Tasks]
      security: [ { cookieAuth: [] } ]
      summary: Liste des tâches
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: status
          required: false
          schema: { type: string, enum: [TODO, IN_PROGRESS, DONE] }
        - in: query
          name: projectId
          required: false
          schema: { type: string }
        - in: query
          name: phase
          required: false
          schema: { type: string }
        - in: query
          name: assignee
          required: false
          schema: { type: string }
        - in: query
          name: categoryReferenceId
          required: false
          schema: { type: string }
        - in: query
          name: tagReferenceId
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Liste
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Task' }
    post:
      tags: [Pro / Tasks]
      security: [ { cookieAuth: [] } ]
      summary: Crée une tâche
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title: { type: string }
                projectId: { type: string, nullable: true }
                assigneeUserId: { type: string, nullable: true }
                status: { type: string, enum: [TODO, IN_PROGRESS, DONE], nullable: true }
                dueDate: { type: string, format: date-time, nullable: true }
                categoryReferenceId: { type: string, nullable: true }
                tagReferenceIds:
                  type: array
                  items: { type: string }
      responses:
        '201':
          description: Tâche
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Task' } }
  /api/pro/businesses/{businessId}/tasks/{taskId}:
    get:
      tags: [Pro / Tasks]
      security: [ { cookieAuth: [] } ]
      summary: Détail tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: taskId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Tâche
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Task' } }
    patch:
      tags: [Pro / Tasks]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: taskId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                status: { type: string, enum: [TODO, IN_PROGRESS, DONE], nullable: true }
                progress: { type: integer, nullable: true }
                projectId: { type: string, nullable: true }
                assigneeUserId: { type: string, nullable: true }
                dueDate: { type: string, format: date-time, nullable: true }
                phase: { type: string, nullable: true }
                notes: { type: string, nullable: true }
                categoryReferenceId: { type: string, nullable: true }
                tagReferenceIds:
                  type: array
                  items: { type: string }
      responses:
        '200':
          description: Tâche
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Task' } }
    delete:
      tags: [Pro / Tasks]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: taskId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/processes:
    get:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Liste des process (actifs par défaut)
      description: Utiliser `archived=1` pour inclure les process archivés. IDs BigInt en string, réponses no-store + x-request-id.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: archived
          required: false
          schema: { type: string, enum: ['0', '1', 'true'] }
      responses:
        '200':
          description: Liste des process
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Process' }
    post:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Crée un process
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:create.
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcessCreate' }
      responses:
        '201':
          description: Process créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/ProcessWithSteps' }

  /api/pro/businesses/{businessId}/processes/{processId}:
    get:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Détail process (avec étapes)
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
      responses:
        '200':
          description: Process + étapes
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/ProcessWithSteps' }
    patch:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un process (nom, description, archive/unarchive)
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:update.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcessUpdate' }
      responses:
        '200':
          description: Process mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/ProcessWithSteps' }
    delete:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un process
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:delete.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
      responses:
        '204':
          description: Process supprimé

  /api/pro/businesses/{businessId}/processes/{processId}/steps:
    post:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Ajoute une étape
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:steps:create.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcessStepCreate' }
      responses:
        '201':
          description: Étape créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/ProcessStep' }

  /api/pro/businesses/{businessId}/processes/{processId}/steps/{stepId}:
    patch:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une étape (titre/description/position/isDone)
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:steps:update.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
        - $ref: '#/components/parameters/ProcessStepId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProcessStepUpdate' }
      responses:
        '200':
          description: Étape mise à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/ProcessStep' }
    delete:
      tags: [Pro / Processes]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une étape
      description: ADMIN/OWNER. CSRF (Origin) requis + rate limit pro:processes:steps:delete.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ProcessId'
        - $ref: '#/components/parameters/ProcessStepId'
      responses:
        '204':
          description: Étape supprimée

  /api/pro/businesses/{businessId}/interactions:
    get:
      tags: [Pro / Interactions]
      security: [ { cookieAuth: [] } ]
      summary: Liste des interactions
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Interactions]
      security: [ { cookieAuth: [] } ]
      summary: Crée une interaction
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, content]
              properties:
                type: { type: string }
                content: { type: string }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/interactions/{interactionId}:
    patch:
      tags: [Pro / Interactions]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une interaction
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: interactionId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Interactions]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une interaction
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: interactionId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/references:
    get:
      tags: [Pro / References]
      security: [ { cookieAuth: [] } ]
      summary: Liste des références (catégories, tags, numérotation, automations)
      description: >
        VIEWER+ accès. Filtrage par type, recherche et inclusion des archivés. Toutes les réponses incluent `x-request-id`
        et `cache-control: no-store`.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: type
          required: false
          schema: { $ref: '#/components/schemas/BusinessReferenceType' }
        - in: query
          name: search
          required: false
          schema: { type: string }
        - in: query
          name: includeArchived
          required: false
          schema: { type: boolean }
      responses:
        '200':
          description: Liste de références
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/BusinessReference' }
    post:
      tags: [Pro / References]
      security: [ { cookieAuth: [] } ]
      summary: Crée une référence
      description: ADMIN/OWNER uniquement. CSRF (Origin) requis + rate limit.
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, name]
              properties:
                type: { $ref: '#/components/schemas/BusinessReferenceType' }
                name: { type: string }
                value: { type: string, nullable: true }
      responses:
        '201':
          description: Référence créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/BusinessReference' }

  /api/pro/businesses/{businessId}/references/{referenceId}:
    patch:
      tags: [Pro / References]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une référence
      description: ADMIN/OWNER uniquement. CSRF (Origin) requis + rate limit.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: referenceId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                value: { type: string, nullable: true }
                isArchived: { type: boolean }
      responses:
        '200':
          description: Référence mise à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/BusinessReference' }
    delete:
      tags: [Pro / References]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une référence
      description: ADMIN/OWNER uniquement. CSRF (Origin) requis + rate limit.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: referenceId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/settings:
    get:
      tags: [Pro / Settings]
      security: [ { cookieAuth: [] } ]
      summary: Récupère les paramètres d’entreprise
      description: >
        Crée des paramètres par défaut si absents. Requiert rôle VIEWER+.
        Toutes les réponses incluent `x-request-id` et `cache-control: no-store`.
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200':
          description: Paramètres
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/BusinessSettings' }
    patch:
      tags: [Pro / Settings]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour les paramètres d’entreprise
      description: ADMIN/OWNER uniquement. CSRF (Origin) requis + rate limit.
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                invoicePrefix: { type: string }
                quotePrefix: { type: string }
                defaultDepositPercent: { type: integer, minimum: 0, maximum: 100 }
                paymentTermsDays: { type: integer, minimum: 0, maximum: 365 }
                enableAutoNumbering: { type: boolean }
                vatRatePercent: { type: integer, minimum: 0, maximum: 100 }
                vatEnabled: { type: boolean }
                allowMembersInvite: { type: boolean }
                allowViewerExport: { type: boolean }
                integrationStripeEnabled: { type: boolean }
                integrationStripePublicKey: { type: string, nullable: true }
                accountInventoryCode: { type: string }
                accountCogsCode: { type: string }
                accountCashCode: { type: string }
                accountRevenueCode: { type: string }
                ledgerSalesAccountCode: { type: string }
                ledgerVatCollectedAccountCode: { type: string }
                ledgerCashAccountCode: { type: string }
      responses:
        '200':
          description: Paramètres mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/BusinessSettings' }

  /api/pro/businesses/{businessId}/services:
    get:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Liste des services catalogue
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: q
          required: false
          schema: { type: string }
        - in: query
          name: type
          required: false
          schema: { type: string }
        - in: query
          name: categoryReferenceId
          required: false
          schema: { type: string }
        - in: query
          name: tagReferenceId
          required: false
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Crée un service catalogue
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, code]
              properties:
                code: { type: string }
                name: { type: string }
                type: { type: string }
                defaultPriceCents: { type: integer }
                categoryReferenceId: { type: string, nullable: true }
                tagReferenceIds:
                  type: array
                  items: { type: string }
                description: { type: string, nullable: true }
                tjmCents: { type: integer, nullable: true }
                durationHours: { type: integer, nullable: true }
                vatRate: { type: integer, nullable: true }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/services/import:
    post:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Import CSV des services
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ServiceImportRequest' }
      responses:
        '200':
          description: Résultat import
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ServiceImportResponse' }
  /api/pro/businesses/{businessId}/services/{serviceId}:
    get:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Détail service
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    patch:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un service
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code: { type: string }
                name: { type: string }
                type: { type: string, nullable: true }
                categoryReferenceId: { type: string, nullable: true }
                tagReferenceIds:
                  type: array
                  items: { type: string }
                defaultPriceCents: { type: integer, nullable: true }
                tjmCents: { type: integer, nullable: true }
                durationHours: { type: integer, nullable: true }
                vatRate: { type: integer, nullable: true }
                description: { type: string, nullable: true }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un service
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/services/{serviceId}/templates:
    get:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Liste des templates de tâches
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Crée un template de tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/services/{serviceId}/templates/{templateId}:
    patch:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un template de tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
        - name: templateId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un template de tâche
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
        - name: templateId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/services/{serviceId}/templates/seed:
    post:
      tags: [Pro / Services]
      security: [ { cookieAuth: [] } ]
      summary: Génère des templates par défaut
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - $ref: '#/components/parameters/ServiceId'
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/members:
    get:
      tags: [Pro / Members]
      security: [ { cookieAuth: [] } ]
      summary: Liste des membres (avec profils)
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200':
          description: Membres
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Member' }
  /api/pro/businesses/{businessId}/members/{userId}:
    get:
      tags: [Pro / Members]
      security: [ { cookieAuth: [] } ]
      summary: Détail membre (profil employé)
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Membre
          content:
            application/json:
              schema:
                type: object
                properties:
                  member: { $ref: '#/components/schemas/Member' }
    patch:
      tags: [Pro / Members]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour rôle/profil employé/permissions
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: userId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role: { type: string, enum: [OWNER, ADMIN, MEMBER, VIEWER] }
                employeeProfile: { $ref: '#/components/schemas/EmployeeProfileInput' }
                permissions:
                  type: array
                  items: { $ref: '#/components/schemas/BusinessPermission' }
      responses:
        '200':
          description: Membre mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  member: { $ref: '#/components/schemas/Member' }
    delete:
      tags: [Pro / Members]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un membre
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: userId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/products:
    get:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Liste les produits
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: archived
          schema: { type: string, enum: ['0', '1'] }
      responses:
        '200':
          description: Produits
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Product' }
    post:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Crée un produit
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sku, name]
              properties:
                sku: { type: string }
                name: { type: string }
                unit: { $ref: '#/components/schemas/ProductUnit' }
                salePriceCents: { type: string, nullable: true }
                purchasePriceCents: { type: string, nullable: true }
      responses:
        '201':
          description: Produit créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  product: { $ref: '#/components/schemas/Product' }

  /api/pro/businesses/{businessId}/products/{productId}:
    get:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Détail produit (inclut stock)
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Produit
          content:
            application/json:
              schema:
                type: object
                properties:
                  product: { $ref: '#/components/schemas/Product' }
    patch:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un produit
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                sku: { type: string }
                name: { type: string }
                description: { type: string, nullable: true }
                unit: { $ref: '#/components/schemas/ProductUnit' }
                salePriceCents: { type: string, nullable: true }
                purchasePriceCents: { type: string, nullable: true }
                isArchived: { type: boolean }
      responses:
        '200':
          description: Produit mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  product: { $ref: '#/components/schemas/Product' }
    delete:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Archive le produit
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Archivé }

  /api/pro/businesses/{businessId}/products/{productId}/movements:
    get:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Liste des mouvements d'inventaire
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Mouvements
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/InventoryMovement' }
    post:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Crée un mouvement de stock
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, quantity]
              properties:
                type: { $ref: '#/components/schemas/InventoryMovementType' }
                source: { $ref: '#/components/schemas/InventoryMovementSource' }
                quantity: { type: number }
                unitCostCents: { type: string, nullable: true }
                reason: { type: string, nullable: true }
                date: { type: string, format: date-time, nullable: true }
                createFinanceEntry:
                  type: boolean
                  description: Crée une écriture Finance liée (inventoryMovementId) avec metadata auto=true
                financeType:
                  type: string
                  enum: [INCOME, EXPENSE]
                  nullable: true
                  description: Forcé si fourni, sinon IN => EXPENSE, OUT => INCOME
      responses:
        '201':
          description: Mouvement créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  movement: { $ref: '#/components/schemas/InventoryMovement' }

  /api/pro/businesses/{businessId}/products/{productId}/movements/{movementId}:
    patch:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour un mouvement (quantité/raison/date/coût) et recalcule la finance liée
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
        - name: movementId
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                quantity: { type: number }
                reason: { type: string, nullable: true }
                date: { type: string, format: date-time, nullable: true }
                unitCostCents: { type: string, nullable: true }
      responses:
        '200':
          description: Mouvement mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  movement: { $ref: '#/components/schemas/InventoryMovement' }
    delete:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Supprime un mouvement et nettoie la finance auto associée
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: productId
          in: path
          required: true
          schema: { type: string }
        - name: movementId
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Supprimé }

  /api/pro/businesses/{businessId}/inventory/summary:
    get:
      tags: [Pro / Stock]
      security: [ { cookieAuth: [] } ]
      summary: Synthèse du stock courant par produit
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200':
          description: Résumé stock
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/InventorySummaryRow' }

  /api/pro/businesses/{businessId}/ledger:
    get:
      tags: [Pro / Ledger]
      security: [ { cookieAuth: [] } ]
      summary: Liste des écritures comptables
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: from
          schema: { type: string, format: date-time, nullable: true }
        - in: query
          name: to
          schema: { type: string, format: date-time, nullable: true }
        - in: query
          name: sourceType
          schema: { type: string, enum: [INVENTORY_MOVEMENT, INVOICE_STOCK_CONSUMPTION, INVOICE_CASH_SALE], nullable: true }
        - in: query
          name: sourceId
          schema: { type: string, nullable: true }
        - in: query
          name: limit
          schema: { type: integer, default: 50 }
        - in: query
          name: cursor
          schema: { type: string, nullable: true }
      responses:
        '200':
          description: Écritures
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/LedgerEntry' }
                  nextCursor: { type: string, nullable: true }

  /api/pro/businesses/{businessId}/ledger/{entryId}:
    get:
      tags: [Pro / Ledger]
      security: [ { cookieAuth: [] } ]
      summary: Détail d'une écriture comptable
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: entryId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Entrée comptable
          content:
            application/json:
              schema:
                type: object
                properties:
                  item: { $ref: '#/components/schemas/LedgerEntry' }

  /api/pro/businesses/{businessId}/invites:
    get:
      tags: [Pro / Invites]
      security: [ { cookieAuth: [] } ]
      summary: Liste des invitations
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    post:
      tags: [Pro / Invites]
      security: [ { cookieAuth: [] } ]
      summary: Crée une invitation
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, role]
              properties:
                email: { type: string, format: email }
                role: { $ref: '#/components/schemas/BusinessRole' }
      responses:
        '201': { $ref: '#/components/responses/Ok' }
  /api/pro/businesses/{businessId}/invites/{inviteId}:
    delete:
      tags: [Pro / Invites]
      security: [ { cookieAuth: [] } ]
      summary: Révoque une invitation
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: inviteId
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Révoqué }
  /api/pro/businesses/invites/accept:
    post:
      tags: [Pro / Invites]
      security: [ { cookieAuth: [] } ]
      summary: Accepte une invitation par token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/finances:
    get:
      tags: [Pro / Finances]
      security: [ { cookieAuth: [] } ]
      summary: Liste des opérations financières
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: type
          required: false
          schema: { type: string, enum: [INCOME, EXPENSE] }
        - in: query
          name: projectId
          required: false
          schema: { type: string }
        - in: query
          name: from
          required: false
          schema: { type: string, format: date-time }
        - in: query
          name: to
          required: false
          schema: { type: string, format: date-time }
        - in: query
          name: category
          required: false
          schema: { type: string }
        - in: query
          name: categoryReferenceId
          required: false
          schema: { type: string }
        - in: query
          name: tagReferenceId
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Liste des opérations
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Finance' }
    post:
      tags: [Pro / Finances]
      security: [ { cookieAuth: [] } ]
      summary: Crée une opération financière
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FinanceCreate' }
      responses:
        '201': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/finances/treasury:
    get:
      tags: [Pro / Finance Advanced]
      security: [ { cookieAuth: [] } ]
      summary: Synthèse trésorerie
      description: |
        VIEWER+. Totaux revenus/dépenses/net + séries mensuelles (12 mois) et top catégories.
        Réponses: `x-request-id` + `cache-control: no-store`.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - in: query
          name: from
          required: false
          schema: { type: string, format: date-time }
        - in: query
          name: to
          required: false
          schema: { type: string, format: date-time }
      responses:
        '200':
          description: Synthèse trésorerie
          content:
            application/json:
              schema: { $ref: '#/components/schemas/TreasurySummary' }

  /api/pro/businesses/{businessId}/finances/vat:
    get:
      tags: [Pro / Finance Advanced]
      security: [ { cookieAuth: [] } ]
      summary: Synthèse TVA
      description: |
        VIEWER+. Utilise les écritures Finance avec catégories VAT_COLLECTED / VAT_PAID. Si aucune écriture détectée, renvoie isConfigured=false.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
      responses:
        '200':
          description: Synthèse TVA
          content:
            application/json:
              schema: { $ref: '#/components/schemas/VatSummary' }

  /api/pro/businesses/{businessId}/finances/forecasting:
    get:
      tags: [Pro / Finance Advanced]
      security: [ { cookieAuth: [] } ]
      summary: Prévisions simples
      description: |
        VIEWER+. Historique 6 mois + projection 3 mois basée sur la moyenne des 3 derniers mois.
      parameters:
        - $ref: '#/components/parameters/BusinessId'
      responses:
        '200':
          description: Prévisions
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ForecastSummary' }
  /api/pro/businesses/{businessId}/finances/{financeId}:
    get:
      tags: [Pro / Finances]
      security: [ { cookieAuth: [] } ]
      summary: Détail finance
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: financeId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Finance
          content:
            application/json:
              schema:
                type: object
                properties: { item: { $ref: '#/components/schemas/Finance' } }
    patch:
      tags: [Pro / Finances]
      security: [ { cookieAuth: [] } ]
      summary: Met à jour une finance
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: financeId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }
    delete:
      tags: [Pro / Finances]
      security: [ { cookieAuth: [] } ]
      summary: Supprime une finance
      parameters:
        - $ref: '#/components/parameters/BusinessId'
        - name: financeId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { $ref: '#/components/responses/Ok' }

  /api/pro/businesses/{businessId}/leave:
    post:
      tags: [Pro / Business]
      security: [ { cookieAuth: [] } ]
      summary: Quitte un business
      parameters: [ { $ref: '#/components/parameters/BusinessId' } ]
      responses:
        '200': { $ref: '#/components/responses/Ok' }

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token

  parameters:
    BusinessId:
      name: businessId
      in: path
      required: true
      schema: { type: string }
    ClientId:
      name: clientId
      in: path
      required: true
      schema: { type: string }
    ProspectId:
      name: prospectId
      in: path
      required: true
      schema: { type: string }
    ProjectId:
      name: projectId
      in: path
      required: true
      schema: { type: string }
    ProcessId:
      name: processId
      in: path
      required: true
      schema: { type: string }
    ProcessStepId:
      name: stepId
      in: path
      required: true
      schema: { type: string }
    QuoteId:
      name: quoteId
      in: path
      required: true
      schema: { type: string }
    InvoiceId:
      name: invoiceId
      in: path
      required: true
      schema: { type: string }
    AccountId:
      name: accountId
      in: path
      required: true
      schema: { type: string }
    TransactionId:
      name: transactionId
      in: path
      required: true
      schema: { type: string }
    ServiceId:
      name: serviceId
      in: path
      required: true
      schema: { type: string }

  responses:
    Error:
      description: Erreur standard
      content:
        application/json:
          schema: { $ref: '#/components/schemas/ErrorResponse' }
    Ok:
      description: Opération réussie
      content:
        application/json:
          schema:
            type: object
            properties:
              ok: { type: boolean, example: true }

  schemas:
    ErrorResponse:
      type: object
      properties:
        error: { type: string }
        reason: { type: string, nullable: true }
    User:
      type: object
      properties:
        id: { type: string }
        email: { type: string, format: email }
        name: { type: string, nullable: true }
        role: { type: string, enum: [USER, ADMIN] }
        createdAt: { type: string, format: date-time }
    RegisterRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        name: { type: string, nullable: true }
    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string }
    Business:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
        ownerId: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    BusinessRole:
      type: string
      enum: [OWNER, ADMIN, MEMBER, VIEWER]
    Client:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        name: { type: string }
        email: { type: string, nullable: true }
        websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
        phone: { type: string, nullable: true }
        notes: { type: string, nullable: true }
        status: { type: string, enum: [ACTIVE, PAUSED, FORMER] }
        leadSource: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        categoryReferenceName: { type: string, nullable: true }
        tagReferences:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    ClientCreate:
      type: object
      required: [name]
      properties:
        name: { type: string }
        email: { type: string, format: email, nullable: true }
        websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
        phone: { type: string, nullable: true }
        notes: { type: string, nullable: true }
        status: { type: string, enum: [ACTIVE, PAUSED, FORMER], nullable: true }
        leadSource: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        tagReferenceIds:
          type: array
          items: { type: string }
    ClientUpdate:
      type: object
      properties:
        name: { type: string }
        email: { type: string, format: email, nullable: true }
        websiteUrl: { type: string, nullable: true, example: 'https://example.com' }
        phone: { type: string, nullable: true }
        notes: { type: string, nullable: true }
        status: { type: string, enum: [ACTIVE, PAUSED, FORMER], nullable: true }
        leadSource: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        tagReferenceIds:
          type: array
          items: { type: string }
    Prospect:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        name: { type: string }
        status: { type: string }
        createdAt: { type: string, format: date-time }
    ProspectCreate:
      type: object
      required: [name]
      properties:
        name: { type: string }
        contactEmail: { type: string, nullable: true }
    ProspectUpdate:
      type: object
      properties:
        name: { type: string }
        status: { type: string }
    Project:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        clientId: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        categoryReferenceName: { type: string, nullable: true }
        tagReferences:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
        name: { type: string }
        status: { type: string }
        quoteStatus: { type: string }
        depositStatus: { type: string }
        createdAt: { type: string, format: date-time }
    ProjectUpdate:
      type: object
      properties:
        name: { type: string }
        status: { type: string }
        categoryReferenceId: { type: string, nullable: true }
        tagReferenceIds:
          type: array
          items: { type: string }
        startDate: { type: string, format: date-time, nullable: true }
        endDate: { type: string, format: date-time, nullable: true }
    Quote:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        projectId: { type: string }
        number: { type: string, nullable: true, description: 'Attribué quand le devis passe en SENT' }
        status: { type: string, enum: [DRAFT, SENT, SIGNED, CANCELLED, EXPIRED] }
        currency: { type: string }
        depositPercent: { type: integer }
        totalCents: { type: string }
        depositCents: { type: string }
        balanceCents: { type: string }
        issuedAt: { type: string, format: date-time, nullable: true }
        expiresAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }
    Invoice:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        projectId: { type: string }
        number: { type: string, nullable: true, description: 'Attribué quand la facture passe en SENT' }
        status: { type: string, enum: [DRAFT, SENT, PAID, CANCELLED] }
        currency: { type: string }
        totalCents: { type: string }
        depositCents: { type: string }
        balanceCents: { type: string }
        issuedAt: { type: string, format: date-time, nullable: true }
        dueAt: { type: string, format: date-time, nullable: true }
        paidAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }
        reservationStatus:
          type: string
          enum: [ACTIVE, RELEASED, CONSUMED]
          nullable: true
          description: 'SENT réserve le stock, PAID le consomme'
        consumptionLedgerEntryId: { type: string, nullable: true }
        cashSaleLedgerEntryId: { type: string, nullable: true }
    Finance:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        projectId: { type: string, nullable: true }
        projectName: { type: string, nullable: true }
        inventoryMovementId: { type: string, nullable: true, description: 'Lié à un mouvement de stock auto-généré' }
        inventoryProductId: { type: string, nullable: true }
        type: { type: string, enum: [INCOME, EXPENSE] }
        amountCents: { type: string }
        amount: { type: number }
        category: { type: string }
        categoryReferenceId: { type: string, nullable: true }
        categoryReferenceName: { type: string, nullable: true }
        tagReferences:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
        date: { type: string, format: date-time }
        note: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    BusinessReferenceType:
      type: string
      enum: [CATEGORY, TAG, NUMBERING, AUTOMATION]
    BusinessPermission:
      type: string
      enum: [TEAM_EDIT, FINANCE_EDIT]
    EmployeeProfile:
      type: object
      properties:
        id: { type: string }
        jobTitle: { type: string, nullable: true }
        contractType: { type: string, nullable: true }
        startDate: { type: string, format: date-time, nullable: true }
        endDate: { type: string, format: date-time, nullable: true }
        weeklyHours: { type: integer, nullable: true }
        hourlyCostCents: { type: string, nullable: true }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        notes: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    EmployeeProfileInput:
      type: object
      properties:
        jobTitle: { type: string, nullable: true }
        contractType: { type: string, nullable: true }
        startDate: { type: string, format: date-time, nullable: true }
        endDate: { type: string, format: date-time, nullable: true }
        weeklyHours: { type: integer, nullable: true }
        hourlyCostCents: { type: string, nullable: true }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        notes: { type: string, nullable: true }
    LedgerLine:
      type: object
      properties:
        id: { type: string }
        accountCode: { type: string }
        accountName: { type: string, nullable: true }
        debitCents: { type: string, nullable: true }
        creditCents: { type: string, nullable: true }
        metadata: {}
        createdAt: { type: string, format: date-time }
    LedgerEntry:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        date: { type: string, format: date-time }
        memo: { type: string, nullable: true }
        sourceType: { type: string, enum: [INVENTORY_MOVEMENT, INVOICE_STOCK_CONSUMPTION, INVOICE_CASH_SALE] }
        sourceId: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        lines:
          type: array
          items: { $ref: '#/components/schemas/LedgerLine' }
    Member:
      type: object
      properties:
        userId: { type: string }
        email: { type: string }
        role: { type: string, enum: [OWNER, ADMIN, MEMBER, VIEWER] }
        createdAt: { type: string, format: date-time }
        employeeProfile:
          $ref: '#/components/schemas/EmployeeProfile'
          nullable: true
        permissions:
          type: array
          items: { $ref: '#/components/schemas/BusinessPermission' }
    ProductUnit:
      type: string
      enum: [PIECE, KG, HOUR, LITER, OTHER]
    InventoryMovementType:
      type: string
      enum: [IN, OUT, ADJUST]
    InventoryMovementSource:
      type: string
      enum: [MANUAL, PURCHASE, SALE]
    Product:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        sku: { type: string }
        name: { type: string }
        description: { type: string, nullable: true }
        unit: { $ref: '#/components/schemas/ProductUnit' }
        salePriceCents: { type: string, nullable: true }
        purchasePriceCents: { type: string, nullable: true }
        isArchived: { type: boolean }
        stock: { type: number, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    InventoryMovement:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        productId: { type: string }
        type: { $ref: '#/components/schemas/InventoryMovementType' }
        source: { $ref: '#/components/schemas/InventoryMovementSource' }
        quantity: { type: number }
        unitCostCents: { type: string, nullable: true }
        reason: { type: string, nullable: true }
        date: { type: string, format: date-time }
        createdByUserId: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    InventorySummaryRow:
      type: object
      properties:
        productId: { type: string }
        sku: { type: string }
        name: { type: string }
        unit: { $ref: '#/components/schemas/ProductUnit' }
        stock: { type: number, description: 'Stock physique (onHand)' }
        onHand: { type: number }
        reserved: { type: number }
        available: { type: number }
        salePriceCents: { type: string, nullable: true }
        purchasePriceCents: { type: string, nullable: true }
        lastMovementAt: { type: string, format: date-time, nullable: true }
    BusinessReference:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        type: { $ref: '#/components/schemas/BusinessReferenceType' }
        name: { type: string }
        value: { type: string, nullable: true }
        isArchived: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    BusinessSettings:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        invoicePrefix: { type: string }
        quotePrefix: { type: string }
        defaultDepositPercent: { type: integer }
        paymentTermsDays: { type: integer }
        enableAutoNumbering: { type: boolean }
        nextQuoteNumber: { type: integer, description: 'Séquence courante pour les devis (auto-incrément)' }
        nextInvoiceNumber: { type: integer, description: 'Séquence courante pour les factures (auto-incrément)' }
        vatRatePercent: { type: integer }
        vatEnabled: { type: boolean }
        allowMembersInvite: { type: boolean }
        allowViewerExport: { type: boolean }
        integrationStripeEnabled: { type: boolean }
        integrationStripePublicKey: { type: string, nullable: true }
        accountInventoryCode: { type: string }
        accountCogsCode: { type: string }
        accountCashCode: { type: string }
        accountRevenueCode: { type: string }
        ledgerSalesAccountCode: { type: string }
        ledgerVatCollectedAccountCode: { type: string }
        ledgerCashAccountCode: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    TreasurySummary:
      type: object
      properties:
        businessId: { type: string }
        range:
          type: object
          properties:
            from: { type: string, format: date-time }
            to: { type: string, format: date-time }
        totals:
          type: object
          properties:
            incomeCents: { type: string }
            expenseCents: { type: string }
            netCents: { type: string }
        monthly:
          type: array
          items:
            type: object
            properties:
              month: { type: string, example: '2025-01' }
              incomeCents: { type: string }
              expenseCents: { type: string }
              netCents: { type: string }
        byCategory:
          type: array
          items:
            type: object
            properties:
              category: { type: string }
              netCents: { type: string }
    VatSummary:
      type: object
      properties:
        businessId: { type: string }
        range:
          type: object
          properties:
            from: { type: string, format: date-time }
            to: { type: string, format: date-time }
        isConfigured: { type: boolean }
        message: { type: string, nullable: true }
        totals:
          type: object
          properties:
            collectedCents: { type: string }
            deductibleCents: { type: string }
            balanceCents: { type: string }
        monthly:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              collectedCents: { type: string }
              deductibleCents: { type: string }
              balanceCents: { type: string }
    ForecastSummary:
      type: object
      properties:
        businessId: { type: string }
        historyRange:
          type: object
          properties:
            from: { type: string, format: date-time }
            to: { type: string, format: date-time }
        assumptions:
          type: object
          properties:
            monthsAveraged: { type: integer }
            note: { type: string }
        history:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              incomeCents: { type: string }
              expenseCents: { type: string }
              netCents: { type: string }
        projections:
          type: array
          items:
            type: object
            properties:
              month: { type: string }
              projectedIncomeCents: { type: string }
              projectedExpenseCents: { type: string }
              projectedNetCents: { type: string }
    FinanceCreate:
      type: object
      required: [type, amount, date, category]
      properties:
        type: { type: string, enum: [INCOME, EXPENSE] }
        amount: { type: number }
        category: { type: string }
        date: { type: string, format: date-time }
        note: { type: string, nullable: true }
        projectId: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        tagReferenceIds:
          type: array
          items: { type: string }
    Task:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        projectId: { type: string, nullable: true }
        projectName: { type: string, nullable: true }
        assigneeUserId: { type: string, nullable: true }
        assigneeEmail: { type: string, nullable: true }
        assigneeName: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        categoryReferenceName: { type: string, nullable: true }
        tagReferences:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
        title: { type: string }
        status: { type: string }
        progress: { type: integer }
        notes: { type: string, nullable: true }
        dueDate: { type: string, format: date-time, nullable: true }
        completedAt: { type: string, format: date-time, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    ProcessStatus:
      type: string
      enum: [ACTIVE, ARCHIVED]
    Process:
      type: object
      properties:
        id: { type: string }
        businessId: { type: string }
        name: { type: string }
        description: { type: string, nullable: true }
        status: { $ref: '#/components/schemas/ProcessStatus' }
        stepsCount: { type: integer, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    ProcessWithSteps:
      allOf:
        - $ref: '#/components/schemas/Process'
        - type: object
          properties:
            steps:
              type: array
              items: { $ref: '#/components/schemas/ProcessStep' }
    ProcessCreate:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
        steps:
          type: array
          items: { $ref: '#/components/schemas/ProcessStepCreate' }
    ProcessUpdate:
      type: object
      properties:
        name: { type: string }
        description: { type: string, nullable: true }
        status: { $ref: '#/components/schemas/ProcessStatus' }
        archived: { type: boolean, nullable: true }
    ProcessStep:
      type: object
      properties:
        id: { type: string }
        processId: { type: string }
        title: { type: string }
        description: { type: string, nullable: true }
        position: { type: integer }
        isDone: { type: boolean }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    ProcessStepCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        position: { type: integer, nullable: true }
        isDone: { type: boolean, nullable: true }
    ProcessStepUpdate:
      type: object
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        position: { type: integer }
        isDone: { type: boolean }
    Service:
      type: object
      properties:
        id: { type: string }
        code: { type: string }
        name: { type: string }
        type: { type: string, nullable: true }
        categoryReferenceId: { type: string, nullable: true }
        categoryReferenceName: { type: string, nullable: true }
        tagReferences:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
        defaultPriceCents: { type: string, nullable: true }
        tjmCents: { type: string, nullable: true }
        durationHours: { type: integer, nullable: true }
        vatRate: { type: integer, nullable: true }
        description: { type: string, nullable: true }
    ServiceImportRequest:
      type: object
      properties:
        mapping:
          type: object
          properties:
            code: { type: string }
            name: { type: string }
            description: { type: string }
            price: { type: string }
            vat: { type: string }
            duration: { type: string }
            type: { type: string }
            category: { type: string }
        rows:
          type: array
          items: { type: object, additionalProperties: true }
        options:
          type: object
          properties:
            createMissingCategories: { type: boolean }
      required: [mapping, rows]
    ServiceImportResponse:
      type: object
      properties:
        createdCount: { type: integer }
        updatedCount: { type: integer }
        skippedCount: { type: integer }
        errors:
          type: array
          items:
            type: object
            properties:
              row: { type: integer }
              message: { type: string }
    PersonalAccount:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        type: { type: string }
        currency: { type: string }
    PersonalAccountDetail:
      allOf:
        - $ref: '#/components/schemas/PersonalAccount'
        - type: object
          properties:
            balanceCents: { type: string }
            delta30Cents: { type: string }
    PersonalTransaction:
      type: object
      properties:
        id: { type: string }
        type: { type: string, enum: [INCOME, EXPENSE, TRANSFER] }
        amountCents: { type: string }
        currency: { type: string }
        label: { type: string }
        note: { type: string, nullable: true }
        date: { type: string, format: date-time }
        accountId: { type: string }
    PersonalTransactionCreate:
      type: object
      required: [accountId, type, amountCents, date, label]
      properties:
        accountId: { type: string }
        type: { type: string, enum: [INCOME, EXPENSE, TRANSFER] }
        amountCents: { type: integer }
        date: { type: string, format: date-time }
        label: { type: string }
        note: { type: string, nullable: true }
    PersonalTransactionUpdate:
      type: object
      properties:
        label: { type: string }
        note: { type: string, nullable: true }
        currency: { type: string }
        date: { type: string, format: date-time }
        categoryId: { type: string, nullable: true }
        accountId: { type: string }
        amountCents: { type: string }
        type: { type: string, enum: [INCOME, EXPENSE, TRANSFER] }
