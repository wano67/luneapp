# Bugs backlog (priorisé)

| ID | Gravité | Symptôme | Cause | Fichiers | Repro | Fix proposé | Risque régression | Tests |
|----|---------|----------|-------|----------|-------|-------------|-------------------|-------|
| P0-1 | P0 (corrigé) | Spam `GET /api/pro/businesses` + `/api/pro/businesses/:id`, manifest Turbopack cassé | useEffect dépendant de l’objet contexte (`useActiveBusiness`) + double fetch liste+détail dans `/app/pro/[businessId]/page.tsx` → rerender infini | src/app/app/pro/[businessId]/page.tsx, ActiveBusinessProvider | Ouvrir `/app/pro/[id]` en dev → requêtes en boucle | Dépendances stables (`setActiveBusiness`), retirer fetch liste, single fetch détail. (Déjà appliqué) | Faible après fix; surveiller si deps reintroduites | Ajouter test e2e: navigation `/app/pro/[id]` doit émettre 1 requête détail |
| P1-1 | P1 | Contexte actif potentiellement obsolète (activeProBusinessId non revalidé) | localStorage hydraté sans revalidation API si auto-open désactivé | ProHomeClient, ActiveBusinessProvider | Supprimer l’accès business côté serveur, conserver active id en local → hub affiche “Ouvrir” vers un id invalide | Option: revalider activeId à l’ouverture hub/switch modal avant navigation, sinon nettoyer | Moyen (peut rediriger 403/404) | Ajouter test e2e: activeId invalide → hub ne redirige pas et nettoie localStorage |
| P2-1 | P2 | Modals/AppShell mobile stacking potentiellement bloquant | Z-index multiples (overlay, menu, modal) + scroll-lock simultané | AppShell, Modal | Ouvrir menu mobile puis modal → vérifier tap | Harmoniser z-index et fermer menu avant modal | Faible | Add UI test mobile toggling menu + modal |
| P2-2 | P2 | CSRF peut bloquer toutes mutations en prod si APP_URL/APP_ORIGINS non configurés | `getAllowedOrigins` renvoie [] en prod => 403 | src/server/security/csrf.ts | Déployer sans env → POST retourne 403 | Documenter/envoyer valeurs APP_URL/NEXT_PUBLIC_APP_URL/APP_ORIGINS; fallback dev déjà présent | Moyen | Add deployment checklist env |
| P2-3 | P2 | Contexte value recréée à chaque render (handlers inline) peut causer rerender large | ActiveBusinessProvider value useMemo mais fonctions inline dans deps (switchOpen toggles) | src/app/app/pro/ActiveBusinessProvider.tsx | Consommer contexte largement → rerender | Memoiser handlers via useCallback (open/close) si besoin | Faible | Add perf test (render count) |
