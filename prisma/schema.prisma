generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/**
 * Rôles globaux de l'utilisateur (dans l'app entière)
 */
enum UserRole {
  USER
  ADMIN
}

/**
 * Rôles au niveau d'une entreprise
 */
enum BusinessRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

/**
 * Statut d'une invitation d'entreprise
 */
enum BusinessInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum LeadSource {
  UNKNOWN
  OUTBOUND
  INBOUND
  REFERRAL
  OTHER
}

enum ProspectStatus {
  NEW
  FOLLOW_UP
  WON
  LOST
}

enum QualificationLevel {
  COLD
  WARM
  HOT
}

enum ProspectPipelineStatus {
  NEW
  IN_DISCUSSION
  OFFER_SENT
  FOLLOW_UP
  CLOSED
}

enum ClientStatus {
  ACTIVE
  PAUSED
  FORMER
}

/**
 * Utilisateur de l'app
 */
model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Entreprises que l'utilisateur a créées
  ownedBusinesses     Business[]           @relation("BusinessOwner")
  // Entreprises auxquelles il appartient (via membership)
  businessMemberships BusinessMembership[]
  assignedTasks       Task[]
  quotesCreated       Quote[]   @relation("QuoteCreatedBy")
  invoicesCreated     Invoice[] @relation("InvoiceCreatedBy")

  // Wallet (perso)
  personalAccounts     PersonalAccount[]
  personalTransactions PersonalTransaction[]
  personalCategories   PersonalCategory[]
  interactionsCreated  Interaction[] @relation("InteractionCreatedBy")
}

/**
 * Entreprise (espace PRO)
 */
model Business {
  id   BigInt @id @default(autoincrement())
  name String

  ownerId BigInt
  owner   User   @relation("BusinessOwner", fields: [ownerId], references: [id])

  memberships BusinessMembership[]
  invites     BusinessInvite[]
  prospects   Prospect[]
  clients     Client[]
  projects    Project[]
  tasks       Task[]
  finances    Finance[]
  services    Service[]
  interactions Interaction[]
  quotes      Quote[]
  invoices    Invoice[]
  references  BusinessReference[]
  settings    BusinessSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * Lien utilisateur <-> entreprise, avec un rôle
 */
model BusinessMembership {
  id         BigInt       @id @default(autoincrement())
  businessId BigInt
  userId     BigInt
  role       BusinessRole

  business Business @relation(fields: [businessId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@unique([businessId, userId])
}

/**
 * Invitation pour rejoindre une entreprise
 */
model BusinessInvite {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  email      String
  role       BusinessRole
  status     BusinessInviteStatus @default(PENDING)
  token      String               @unique
  expiresAt  DateTime?
  createdAt  DateTime             @default(now())

  business Business @relation(fields: [businessId], references: [id])
}

model Prospect {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name         String
  title        String?
  contactName  String?
  contactEmail String?
  contactPhone String?

  source             LeadSource?
  interestNote       String?
  qualificationLevel QualificationLevel?

  projectIdea     String?
  estimatedBudget Int?
  origin          String?
  probability     Int       @default(0)
  nextActionDate  DateTime?

  firstContactAt DateTime?
  pipelineStatus ProspectPipelineStatus @default(NEW)
  status          ProspectStatus        @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectQuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  SIGNED
}

enum ProjectDepositStatus {
  NOT_REQUIRED
  PENDING
  PAID
}

enum QuoteStatus {
  DRAFT
  SENT
  SIGNED
  CANCELLED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPhase {
  CADRAGE
  UX
  DESIGN
  DEV
  SEO
  LAUNCH
  FOLLOW_UP
}

enum FinanceType {
  INCOME
  EXPENSE
}

enum InteractionType {
  CALL
  MEETING
  EMAIL
  NOTE
  MESSAGE
}

enum BusinessReferenceType {
  CATEGORY
  TAG
  NUMBERING
  AUTOMATION
}

model Client {
  id              BigInt       @id @default(autoincrement())
  businessId      BigInt
  name            String
  companyName     String?
  mainContactName String?
  email           String?
  phone           String?
  address         String?
  sector          String?
  entryDate       DateTime?
  leadSource      LeadSource?
  needsType       String?
  estimatedBudget Int?
  notes           String?
  status          ClientStatus @default(ACTIVE)

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  projects Project[]
  interactions Interaction[]
  quotes    Quote[]
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, name])
}

model Project {
  id         BigInt        @id @default(autoincrement())
  businessId BigInt
  clientId   BigInt?
  name       String
  status     ProjectStatus @default(PLANNED)
  quoteStatus   ProjectQuoteStatus   @default(DRAFT)
  depositStatus ProjectDepositStatus @default(PENDING)
  startedAt     DateTime?
  archivedAt    DateTime?
  startDate  DateTime?
  endDate    DateTime?

  business Business @relation(fields: [businessId], references: [id])
  client   Client?  @relation(fields: [clientId], references: [id])
  tasks    Task[]
  finances Finance[]
  projectServices ProjectService[]
  interactions Interaction[]
  quotes    Quote[]
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
}

model Task {
  id             BigInt      @id @default(autoincrement())
  businessId     BigInt
  projectId      BigInt?
  assigneeUserId BigInt?
  title          String
  status         TaskStatus  @default(TODO)
  dueDate        DateTime?
  phase          TaskPhase?
  progress       Int         @default(0)
  completedAt    DateTime?
  notes          String?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  assignee User?    @relation(fields: [assigneeUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, projectId])
}

model Finance {
  id         BigInt      @id @default(autoincrement())
  businessId BigInt
  projectId  BigInt?
  type       FinanceType
  amountCents BigInt
  category   String
  date       DateTime
  note       String?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, date])
  @@index([businessId, type])
}

/**
 * Catalogue de services vendables
 */
model Service {
  id          BigInt   @id @default(autoincrement())
  businessId  BigInt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  code        String   @unique
  name        String
  type        String?
  description String?
  defaultPriceCents BigInt?
  tjmCents    BigInt?
  durationHours Int?
  vatRate     Int?

  taskTemplates   ServiceTaskTemplate[]
  projectServices ProjectService[]
  quoteItems      QuoteItem[]
  invoiceItems    InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, code])
}

model ServiceTaskTemplate {
  id        BigInt    @id @default(autoincrement())
  serviceId BigInt
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  phase     TaskPhase?
  title     String
  defaultAssigneeRole String?
  defaultDueOffsetDays Int?
  createdAt DateTime @default(now())
}

model ProjectService {
  id         BigInt   @id @default(autoincrement())
  projectId  BigInt
  serviceId  BigInt
  quantity   Int      @default(1)
  priceCents BigInt?
  notes      String?
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([projectId, serviceId])
}

model Interaction {
  id        BigInt   @id @default(autoincrement())
  businessId BigInt
  clientId  BigInt?
  projectId BigInt?
  type      InteractionType
  content   String
  happenedAt DateTime
  nextActionDate DateTime?
  createdByUserId BigInt?
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy User?   @relation("InteractionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([businessId, clientId])
  @@index([businessId, projectId])
}

model BusinessReference {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  type       BusinessReferenceType
  name       String
  value      String?
  isArchived Boolean              @default(false)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, type, name])
  @@index([businessId, type])
}

model BusinessSettings {
  id                     BigInt   @id @default(autoincrement())
  businessId             BigInt   @unique
  invoicePrefix          String   @default("INV-")
  quotePrefix            String   @default("DEV-")
  defaultDepositPercent  Int      @default(30)
  paymentTermsDays       Int      @default(30)
  enableAutoNumbering    Boolean  @default(true)
  vatRatePercent         Int      @default(20)
  vatEnabled             Boolean  @default(false)
  allowMembersInvite     Boolean  @default(true)
  allowViewerExport      Boolean  @default(false)
  integrationStripeEnabled    Boolean  @default(false)
  integrationStripePublicKey  String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Quote {
  id              BigInt      @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  createdByUserId BigInt
  status          QuoteStatus @default(DRAFT)
  depositPercent  Int         @default(30)
  currency        String      @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  issuedAt        DateTime?
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User    @relation("QuoteCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items    QuoteItem[]
  invoice  Invoice? @relation("QuoteInvoice")
}

model QuoteItem {
  id             BigInt   @id @default(autoincrement())
  quoteId        BigInt
  serviceId      BigInt?
  label          String
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

model Invoice {
  id              BigInt        @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  quoteId         BigInt?       @unique
  createdByUserId BigInt
  status          InvoiceStatus @default(DRAFT)
  depositPercent  Int           @default(30)
  currency        String        @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  issuedAt        DateTime?
  dueAt           DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  quote    Quote?   @relation("QuoteInvoice", fields: [quoteId], references: [id], onDelete: SetNull)
  createdBy User    @relation("InvoiceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items    InvoiceItem[]
}

model InvoiceItem {
  id             BigInt   @id @default(autoincrement())
  invoiceId      BigInt
  serviceId      BigInt?
  label          String
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

/**
 * ===================== WALLET (PERSONAL) =====================
 */

enum PersonalAccountType {
  CURRENT
  SAVINGS
  INVEST
  CASH
}

enum PersonalTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model PersonalAccount {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  type         PersonalAccountType @default(CURRENT)
  currency     String              @default("EUR")
  institution  String?
  iban         String?
  initialCents BigInt              @default(0)

  transactions PersonalTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model PersonalCategory {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  createdAt DateTime @default(now())

  // ✅ inverse relation
  transactions PersonalTransaction[]

  @@unique([userId, name])
}

model PersonalTransaction {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accountId BigInt
  account   PersonalAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  categoryId BigInt?
  category   PersonalCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  type        PersonalTransactionType
  date        DateTime
  amountCents BigInt
  currency    String                  @default("EUR")

  label String
  note  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
}
