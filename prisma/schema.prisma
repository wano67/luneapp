generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/**
 * Rôles globaux de l'utilisateur (dans l'app entière)
 */
enum UserRole {
  USER
  ADMIN
}

/**
 * Rôles au niveau d'une entreprise
 */
enum BusinessRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum BusinessPermission {
  TEAM_EDIT
  FINANCE_EDIT
}

enum ProductUnit {
  PIECE
  KG
  HOUR
  LITER
  OTHER
}

enum ServiceUnit {
  FORFAIT
  HOUR
  DAY
  PIECE
  OTHER
}

enum InventoryMovementType {
  IN
  OUT
  ADJUST
}

enum InventoryReservationStatus {
  ACTIVE
  RELEASED
  CONSUMED
}

enum LedgerSourceType {
  INVENTORY_MOVEMENT
  INVOICE_STOCK_CONSUMPTION
  INVOICE_CASH_SALE
}

enum InventoryMovementSource {
  MANUAL
  PURCHASE
  SALE
}

enum DocumentKind {
  FILE
  INVOICE
  QUOTE
}

/**
 * Statut d'une invitation d'entreprise
 */
enum BusinessInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum LeadSource {
  UNKNOWN
  OUTBOUND
  INBOUND
  REFERRAL
  OTHER
}

enum ProspectStatus {
  NEW
  FOLLOW_UP
  WON
  LOST
}

enum QualificationLevel {
  COLD
  WARM
  HOT
}

enum ProspectPipelineStatus {
  NEW
  IN_DISCUSSION
  OFFER_SENT
  FOLLOW_UP
  CLOSED
}

enum ClientStatus {
  ACTIVE
  PAUSED
  FORMER
}

/**
 * Utilisateur de l'app
 */
model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Entreprises que l'utilisateur a créées
  ownedBusinesses     Business[]           @relation("BusinessOwner")
  // Entreprises auxquelles il appartient (via membership)
  businessMemberships BusinessMembership[]
  assignedTasks       Task[]
  statusUpdatedTasks  Task[] @relation("TaskStatusUpdatedBy")
  completedChecklistItems TaskChecklistItem[] @relation("ChecklistCompletedBy")
  quotesCreated       Quote[]   @relation("QuoteCreatedBy")
  invoicesCreated     Invoice[] @relation("InvoiceCreatedBy")
  paymentsCreated     Payment[] @relation("PaymentCreatedBy")

  // Wallet (perso)
  personalAccounts     PersonalAccount[]
  personalTransactions PersonalTransaction[]
  personalCategories   PersonalCategory[]
  interactionsCreated  Interaction[] @relation("InteractionCreatedBy")
  inventoryMovements   InventoryMovement[]
  ledgerEntriesCreated LedgerEntry[]
  clientsAnonymized    Client[] @relation("ClientAnonymizedBy")
  documentsCreated     BusinessDocument[] @relation("DocumentCreatedBy")
  conversationsCreated Conversation[] @relation("ConversationCreatedBy")
  conversationMembers  ConversationMember[]
  messagesSent         Message[] @relation("MessageSender")
}

/**
 * Entreprise (espace PRO)
 */
model Business {
  id   BigInt @id @default(autoincrement())
  name String
  websiteUrl String?
  legalName String?
  countryCode String @default("FR")
  siret String?
  vatNumber String?
  addressLine1 String?
  addressLine2 String?
  postalCode String?
  city String?
  billingEmail String?
  billingPhone String?
  iban String?
  bic String?
  bankName String?
  accountHolder String?
  billingLegalText String?

  ownerId BigInt
  owner   User   @relation("BusinessOwner", fields: [ownerId], references: [id])

  memberships BusinessMembership[]
  organizationUnits OrganizationUnit[]
  invites     BusinessInvite[]
  prospects   Prospect[]
  clients     Client[]
  projects    Project[]
  tasks       Task[]
  finances    Finance[]
  financeRecurringRules FinanceRecurringRule[]
  payments    Payment[]
  services    Service[]
  serviceProcessTemplates ServiceProcessTemplate[]
  interactions Interaction[]
  quotes      Quote[]
  invoices    Invoice[]
  subscriptions Subscription[]
  documents   BusinessDocument[]
  productImages ProductImage[]
  references  BusinessReference[]
  processes   Process[]
  settings    BusinessSettings?
  numberSequences NumberSequence[]
  products    Product[]
  inventoryMovements InventoryMovement[]
  inventoryReservations InventoryReservation[]
  ledgerEntries        LedgerEntry[]
  projectServiceRecurringRules ProjectServiceRecurringRule[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * Lien utilisateur <-> entreprise, avec un rôle
 */
model BusinessMembership {
  id         BigInt       @id @default(autoincrement())
  businessId BigInt
  userId     BigInt
  role       BusinessRole
  organizationUnitId BigInt?

  business Business @relation(fields: [businessId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  organizationUnit OrganizationUnit? @relation(fields: [organizationUnitId], references: [id], onDelete: SetNull)
  employeeProfile EmployeeProfile?
  permissions     BusinessMemberPermission[]
  projectMembers  ProjectMember[]

  createdAt DateTime @default(now())

  @@unique([businessId, userId])
}

model OrganizationUnit {
  id         BigInt @id @default(autoincrement())
  businessId BigInt
  name       String
  order      Int    @default(0)

  business    Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  memberships BusinessMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, name])
  @@index([businessId, order])
}

model EmployeeProfile {
  id           BigInt         @id @default(autoincrement())
  membershipId BigInt         @unique
  jobTitle     String?
  contractType String?
  startDate    DateTime?
  endDate      DateTime?
  weeklyHours  Int?
  hourlyCostCents BigInt?
  status       EmployeeStatus @default(ACTIVE)
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  membership BusinessMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
}

model BusinessMemberPermission {
  id           BigInt             @id @default(autoincrement())
  membershipId BigInt
  permission   BusinessPermission
  createdAt    DateTime           @default(now())

  membership BusinessMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permission])
  @@index([permission])
}

/**
 * Invitation pour rejoindre une entreprise
 */
model BusinessInvite {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  email      String
  role       BusinessRole
  status     BusinessInviteStatus @default(PENDING)
  token      String               @unique
  expiresAt  DateTime?
  createdAt  DateTime             @default(now())

  business Business @relation(fields: [businessId], references: [id])
}

model Prospect {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name         String
  title        String?
  contactName  String?
  contactEmail String?
  contactPhone String?

  source             LeadSource?
  interestNote       String?
  qualificationLevel QualificationLevel?

  projectIdea     String?
  estimatedBudget Int?
  origin          String?
  probability     Int       @default(0)
  nextActionDate  DateTime?

  firstContactAt DateTime?
  pipelineStatus ProspectPipelineStatus @default(NEW)
  status          ProspectStatus        @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectQuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  SIGNED
}

enum ProjectDepositStatus {
  NOT_REQUIRED
  PENDING
  PAID
}

enum QuoteStatus {
  DRAFT
  SENT
  SIGNED
  CANCELLED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPhase {
  CADRAGE
  UX
  DESIGN
  DEV
  SEO
  LAUNCH
  FOLLOW_UP
}

enum FinanceType {
  INCOME
  EXPENSE
}

enum ProcessStatus {
  ACTIVE
  ARCHIVED
}

enum InteractionType {
  CALL
  MEETING
  EMAIL
  NOTE
  MESSAGE
}

enum BusinessReferenceType {
  CATEGORY
  TAG
  NUMBERING
  AUTOMATION
}

model Client {
  id              BigInt       @id @default(autoincrement())
  businessId      BigInt
  categoryReferenceId BigInt?
  name            String
  websiteUrl      String?
  companyName     String?
  mainContactName String?
  email           String?
  phone           String?
  address         String?
  billingCompanyName String?
  billingContactName String?
  billingEmail       String?
  billingPhone       String?
  billingVatNumber   String?
  billingReference   String?
  billingAddressLine1 String?
  billingAddressLine2 String?
  billingPostalCode   String?
  billingCity         String?
  billingCountryCode  String?
  sector          String?
  entryDate       DateTime?
  leadSource      LeadSource?
  needsType       String?
  estimatedBudget Int?
  notes           String?
  status          ClientStatus @default(ACTIVE)
  archivedAt      DateTime?
  anonymizedAt    DateTime?
  anonymizedByUserId BigInt?
  anonymizationReason String?

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categoryReference BusinessReference? @relation("ClientCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  anonymizedBy   User?     @relation("ClientAnonymizedBy", fields: [anonymizedByUserId], references: [id], onDelete: SetNull)
  tags       ClientTag[]
  projects Project[]
  interactions Interaction[]
  quotes    Quote[]
  invoices  Invoice[]
  payments  Payment[]
  documents BusinessDocument[]
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, name])
  @@index([businessId, categoryReferenceId])
  @@index([businessId, archivedAt])
  @@index([businessId, anonymizedAt])
}

model Project {
  id         BigInt        @id @default(autoincrement())
  businessId BigInt
  clientId   BigInt?
  categoryReferenceId BigInt?
  name       String
  status     ProjectStatus @default(PLANNED)
  quoteStatus   ProjectQuoteStatus   @default(DRAFT)
  depositStatus ProjectDepositStatus @default(PENDING)
  depositPaidAt DateTime?
  billingQuoteId BigInt?
  startedAt     DateTime?
  archivedAt    DateTime?
  startDate  DateTime?
  endDate    DateTime?
  prestationsText String?

  business Business @relation(fields: [businessId], references: [id])
  client   Client?  @relation(fields: [clientId], references: [id])
  categoryReference BusinessReference? @relation("ProjectCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  billingQuote Quote? @relation("ProjectBillingQuote", fields: [billingQuoteId], references: [id], onDelete: SetNull)
  tasks    Task[]
  finances Finance[]
  financeRecurringRules FinanceRecurringRule[]
  payments Payment[]
  projectServices ProjectService[]
  interactions Interaction[]
  tags     ProjectTag[]
  quotes    Quote[]
  invoices  Invoice[]
  projectMembers ProjectMember[]
  projectServiceRecurringRules ProjectServiceRecurringRule[]
  subscriptions Subscription[]
  documents     BusinessDocument[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, categoryReferenceId])
  @@index([billingQuoteId])
}

model ProjectMember {
  id           BigInt @id @default(autoincrement())
  projectId    BigInt
  membershipId BigInt

  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  membership BusinessMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([projectId, membershipId])
  @@index([projectId])
  @@index([membershipId])
}

model Task {
  id             BigInt      @id @default(autoincrement())
  businessId     BigInt
  projectId      BigInt?
  projectServiceId BigInt?
  projectServiceStepId BigInt?
  parentTaskId BigInt?
  assigneeUserId BigInt?
  statusUpdatedAt DateTime?
  statusUpdatedByUserId BigInt?
  categoryReferenceId BigInt?
  title          String
  status         TaskStatus  @default(TODO)
  dueDate        DateTime?
  startDate      DateTime?
  phase          TaskPhase?
  progress       Int         @default(0)
  completedAt    DateTime?
  notes          String?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectService ProjectService? @relation(fields: [projectServiceId], references: [id], onDelete: SetNull)
  projectServiceStep ProjectServiceStep? @relation(fields: [projectServiceStepId], references: [id], onDelete: SetNull)
  parentTask Task? @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: SetNull)
  subtasks Task[] @relation("TaskHierarchy")
  assignee User?    @relation(fields: [assigneeUserId], references: [id], onDelete: SetNull)
  statusUpdatedByUser User? @relation("TaskStatusUpdatedBy", fields: [statusUpdatedByUserId], references: [id], onDelete: SetNull)
  categoryReference BusinessReference? @relation("TaskCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tags     TaskTag[]
  checklistItems TaskChecklistItem[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, projectId])
  @@index([projectServiceId])
  @@index([projectServiceStepId])
  @@index([projectId, projectServiceId])
  @@index([businessId, categoryReferenceId])
  @@index([projectId, statusUpdatedAt])
  @@index([parentTaskId])
}

model Process {
  id          BigInt        @id @default(autoincrement())
  businessId  BigInt
  name        String
  description String?
  status      ProcessStatus @default(ACTIVE)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  steps    ProcessStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
}

model ProcessStep {
  id          BigInt   @id @default(autoincrement())
  processId   BigInt
  title       String
  description String?
  position    Int
  isDone      Boolean  @default(false)

  process Process @relation(fields: [processId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([processId])
}

model Finance {
  id         BigInt      @id @default(autoincrement())
  businessId BigInt
  projectId  BigInt?
  categoryReferenceId BigInt?
  recurringRuleId BigInt?
  inventoryMovementId BigInt? @unique
  inventoryProductId  BigInt?
  type       FinanceType
  amountCents BigInt
  category   String
  vendor     String?
  method     PaymentMethod?
  isRecurring Boolean @default(false)
  recurringUnit RecurringUnit?
  isRuleOverride Boolean @default(false)
  lockedFromRule Boolean @default(false)
  date       DateTime
  note       String?
  deletedAt  DateTime?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  categoryReference BusinessReference? @relation("FinanceCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  recurringRule FinanceRecurringRule? @relation(fields: [recurringRuleId], references: [id], onDelete: SetNull)
  inventoryMovement  InventoryMovement? @relation("InventoryMovementFinance", fields: [inventoryMovementId], references: [id], onDelete: SetNull)
  inventoryProduct   Product?           @relation("ProductFinance", fields: [inventoryProductId], references: [id], onDelete: SetNull)
  tags     FinanceTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, date])
  @@index([businessId, type])
  @@index([businessId, categoryReferenceId])
  @@index([businessId, inventoryProductId])
  @@index([businessId, deletedAt])
  @@index([recurringRuleId])
  @@unique([recurringRuleId, date])
}

model FinanceRecurringRule {
  id         BigInt      @id @default(autoincrement())
  businessId BigInt
  projectId  BigInt?
  categoryReferenceId BigInt?
  type       FinanceType
  amountCents BigInt
  category   String
  vendor     String?
  method     PaymentMethod?
  note       String?
  startDate  DateTime
  endDate    DateTime?
  dayOfMonth Int
  frequency  RecurringUnit @default(MONTHLY)
  nextRunAt  DateTime?
  isActive   Boolean   @default(true)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  categoryReference BusinessReference? @relation("FinanceRecurringCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  entries  Finance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, isActive])
  @@index([businessId, nextRunAt])
  @@index([businessId, projectId])
}

/**
 * Catalogue de services vendables
 */
model Service {
  id          BigInt   @id @default(autoincrement())
  businessId  BigInt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  code        String   @unique
  name        String
  categoryReferenceId BigInt?
  type        String?
  description String?
  defaultPriceCents BigInt?
  tjmCents    BigInt?
  costCents   BigInt?
  unit        ServiceUnit @default(FORFAIT)
  defaultQuantity Int     @default(1)
  durationHours Int?
  vatRate     Int?

  categoryReference BusinessReference? @relation("ServiceCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tags              ServiceTag[]
  taskTemplates   ServiceTaskTemplate[]
  serviceProcessTemplate ServiceProcessTemplate?
  projectServices ProjectService[]
  quoteItems      QuoteItem[]
  invoiceItems    InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, code])
  @@index([businessId, categoryReferenceId])
}

model Product {
  id                 BigInt       @id @default(autoincrement())
  businessId         BigInt
  business           Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sku                String
  skuLower           String
  name               String
  description        String?
  unit               ProductUnit  @default(PIECE)
  salePriceCents     BigInt?
  purchasePriceCents BigInt?
  isArchived         Boolean      @default(false)
  productImages      ProductImage[]
  movements          InventoryMovement[]
  inventoryFinances  Finance[]    @relation("ProductFinance")
  reservationItems   InventoryReservationItem[]
  invoiceItems       InvoiceItem[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([businessId, skuLower])
  @@index([businessId, isArchived])
}

model ProductImage {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  productId  BigInt
  storageKey String
  mimeType   String
  alt        String?
  position   Int      @default(0)
  createdAt  DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([businessId, productId, position])
}

model InventoryMovement {
  id              BigInt                  @id @default(autoincrement())
  businessId      BigInt
  productId       BigInt
  type            InventoryMovementType
  source          InventoryMovementSource @default(MANUAL)
  quantity        Int
  unitCostCents   BigInt?
  reason          String?
  date            DateTime
  createdByUserId BigInt?
  financeEntry    Finance?                @relation("InventoryMovementFinance")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, productId])
  @@index([businessId, date])
}

model InventoryReservation {
  id         BigInt                    @id @default(autoincrement())
  businessId BigInt
  invoiceId  BigInt      @unique
  status     InventoryReservationStatus @default(ACTIVE)
  items      InventoryReservationItem[]

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
}

model InventoryReservationItem {
  id             BigInt @id @default(autoincrement())
  reservationId  BigInt
  productId      BigInt
  quantity       Int
  unitPriceCents BigInt?
  createdAt      DateTime @default(now())

  reservation InventoryReservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  product     Product             @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([productId])
}

model ProjectTag {
  id          BigInt @id @default(autoincrement())
  projectId   BigInt
  referenceId BigInt

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ProjectTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([projectId, referenceId])
  @@index([referenceId])
}

model ServiceTag {
  id          BigInt @id @default(autoincrement())
  serviceId   BigInt
  referenceId BigInt

  service   Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ServiceTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([serviceId, referenceId])
  @@index([referenceId])
}

model ServiceTaskTemplate {
  id        BigInt    @id @default(autoincrement())
  serviceId BigInt
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  phase     TaskPhase?
  title     String
  defaultAssigneeRole String?
  defaultDueOffsetDays Int?
  estimatedMinutes Int?
  position Int @default(0)
  tasks    ServiceTemplateTask[]
  createdAt DateTime @default(now())
}

model ServiceTemplateTask {
  id        BigInt    @id @default(autoincrement())
  templateId BigInt
  template  ServiceTaskTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  title     String
  description String?
  role      String?
  estimatedMinutes Int?
  position  Int @default(0)
  createdAt DateTime @default(now())

  @@index([templateId])
  @@index([templateId, position])
}

model ServiceProcessTemplate {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  serviceId  BigInt   @unique
  name       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  phases   ServiceProcessPhaseTemplate[]

  @@index([businessId])
}

model ServiceProcessPhaseTemplate {
  id         BigInt   @id @default(autoincrement())
  templateId BigInt
  name       String
  order      Int      @default(0)

  template ServiceProcessTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  steps    ServiceProcessStepTemplate[]

  @@index([templateId])
  @@index([templateId, order])
}

model ServiceProcessStepTemplate {
  id         BigInt   @id @default(autoincrement())
  phaseId    BigInt
  name       String
  order      Int      @default(0)
  isBillableMilestone Boolean @default(false)

  phase ServiceProcessPhaseTemplate @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  tasks ServiceProcessTaskTemplate[]

  @@index([phaseId])
  @@index([phaseId, order])
}

model ServiceProcessTaskTemplate {
  id         BigInt   @id @default(autoincrement())
  stepId     BigInt
  title      String
  order      Int      @default(0)
  description String?
  dueOffsetDays Int?
  defaultAssigneeRole String?

  step ServiceProcessStepTemplate @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@index([stepId, order])
}

model ProjectService {
  id         BigInt   @id @default(autoincrement())
  projectId  BigInt
  serviceId  BigInt
  quantity   Int      @default(1)
  priceCents BigInt?
  notes      String?
  titleOverride String?
  description   String?
  discountType  DiscountType @default(NONE)
  discountValue Int?
  billingUnit   BillingUnit  @default(ONE_OFF)
  unitLabel     String?
  position   Int      @default(0)
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  steps   ProjectServiceStep[]
  tasks   Task[]
  recurringRule ProjectServiceRecurringRule?
  subscription Subscription?

  @@index([projectId, serviceId])
  @@index([projectId, position])
}

model ProjectServiceStep {
  id               BigInt  @id @default(autoincrement())
  projectServiceId BigInt
  name             String
  order            Int     @default(0)
  phaseName        String?
  isBillableMilestone Boolean @default(false)
  createdAt        DateTime @default(now())

  projectService ProjectService @relation(fields: [projectServiceId], references: [id], onDelete: Cascade)
  tasks          Task[]

  @@index([projectServiceId])
  @@index([projectServiceId, order])
}

model ProjectServiceRecurringRule {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  projectId  BigInt
  projectServiceId BigInt @unique
  startDate  DateTime
  dayOfMonth Int
  frequency  RecurringUnit @default(MONTHLY)
  nextRunAt  DateTime?
  isActive   Boolean @default(true)
  lastInvoicedAt DateTime?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectService ProjectService @relation(fields: [projectServiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, projectId])
  @@index([businessId, nextRunAt])
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  ENDED
}

model Subscription {
  id         BigInt @id @default(autoincrement())
  businessId BigInt
  clientId   BigInt?
  projectId  BigInt?
  projectServiceId BigInt? @unique
  label      String
  amountCents BigInt
  currency   String @default("EUR")
  startDate  DateTime
  endDate    DateTime?
  commitmentMonths Int?
  billingDay Int
  status     SubscriptionStatus @default(ACTIVE)
  nextInvoiceAt DateTime?
  lastInvoicedAt DateTime?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectService ProjectService? @relation(fields: [projectServiceId], references: [id], onDelete: SetNull)
  periods  SubscriptionPeriod[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, projectId])
  @@index([clientId])
  @@index([projectServiceId])
}

model SubscriptionPeriod {
  id            BigInt @id @default(autoincrement())
  subscriptionId BigInt
  periodStart   DateTime
  periodEnd     DateTime
  invoiceId     BigInt? @unique

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([subscriptionId, periodStart, periodEnd])
  @@index([subscriptionId, periodStart])
  @@index([invoiceId])
}

model Interaction {
  id        BigInt   @id @default(autoincrement())
  businessId BigInt
  clientId  BigInt?
  projectId BigInt?
  type      InteractionType
  content   String
  happenedAt DateTime
  nextActionDate DateTime?
  createdByUserId BigInt?
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy User?   @relation("InteractionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([businessId, clientId])
  @@index([businessId, projectId])
}

model BusinessReference {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  type       BusinessReferenceType
  name       String
  value      String?
  isArchived Boolean              @default(false)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  projectCategories Project[] @relation("ProjectCategoryReference")
  serviceCategories Service[] @relation("ServiceCategoryReference")
  clientCategories  Client[]  @relation("ClientCategoryReference")
  taskCategories    Task[]    @relation("TaskCategoryReference")
  financeCategories Finance[] @relation("FinanceCategoryReference")
  financeRecurringCategories FinanceRecurringRule[] @relation("FinanceRecurringCategoryReference")
  projectTags       ProjectTag[] @relation("ProjectTagReference")
  serviceTags       ServiceTag[] @relation("ServiceTagReference")
  clientTags        ClientTag[] @relation("ClientTagReference")
  taskTags          TaskTag[] @relation("TaskTagReference")
  financeTags       FinanceTag[] @relation("FinanceTagReference")

  @@unique([businessId, type, name])
  @@index([businessId, type])
}

model ClientTag {
  id          BigInt @id @default(autoincrement())
  clientId    BigInt
  referenceId BigInt

  client    Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ClientTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([clientId, referenceId])
  @@index([referenceId])
}

model TaskTag {
  id          BigInt @id @default(autoincrement())
  taskId      BigInt
  referenceId BigInt

  task      Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("TaskTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([taskId, referenceId])
  @@index([referenceId])
}

model TaskChecklistItem {
  id               BigInt   @id @default(autoincrement())
  taskId           BigInt
  title            String
  position         Int      @default(0)
  isCompleted      Boolean  @default(false)
  completedAt      DateTime?
  completedByUserId BigInt?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  task        Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  completedBy User? @relation("ChecklistCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@index([taskId, position])
}

model FinanceTag {
  id          BigInt @id @default(autoincrement())
  financeId   BigInt
  referenceId BigInt

  finance   Finance          @relation(fields: [financeId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("FinanceTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([financeId, referenceId])
  @@index([referenceId])
}

model LedgerEntry {
  id             BigInt          @id @default(autoincrement())
  businessId     BigInt
  date           DateTime
  memo           String?
  sourceType     LedgerSourceType
  sourceId       BigInt?
  createdByUserId BigInt?
  lines          LedgerLine[]

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdBy User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, date])
  @@index([sourceType, sourceId])
  @@unique([sourceType, sourceId])
}

model LedgerLine {
  id          BigInt  @id @default(autoincrement())
  entryId     BigInt
  accountCode String
  accountName String?
  debitCents  BigInt?
  creditCents BigInt?
  metadata    Json?

  entry LedgerEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([entryId])
}

model BusinessSettings {
  id                     BigInt   @id @default(autoincrement())
  businessId             BigInt   @unique
  currency               String   @default("EUR")
  invoicePrefix          String   @default("SF-FAC")
  quotePrefix            String   @default("SF-DEV")
  nextInvoiceNumber      Int      @default(1)
  nextQuoteNumber        Int      @default(1)
  defaultDepositPercent  Int      @default(30)
  paymentTermsDays       Int      @default(30)
  enableAutoNumbering    Boolean  @default(true)
  vatRatePercent         Int      @default(20)
  vatEnabled             Boolean  @default(false)
  allowMembersInvite     Boolean  @default(true)
  allowViewerExport      Boolean  @default(false)
  integrationStripeEnabled    Boolean  @default(false)
  integrationStripePublicKey  String?
  accountInventoryCode   String   @default("3700")
  accountCogsCode        String   @default("6000")
  accountCashCode        String   @default("5300")
  accountRevenueCode     String   @default("7000")
  ledgerSalesAccountCode       String   @default("706")
  ledgerVatCollectedAccountCode String   @default("44571")
  ledgerCashAccountCode        String   @default("512")
  cgvText                String?
  paymentTermsText       String?
  lateFeesText           String?
  fixedIndemnityText     String?
  legalMentionsText      String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

enum DiscountType {
  NONE
  PERCENT
  AMOUNT
}

enum BillingUnit {
  ONE_OFF
  MONTHLY
}

enum PaymentMethod {
  WIRE
  CARD
  CASH
  CHECK
  OTHER
}

enum RecurringUnit {
  MONTHLY
  YEARLY
}

enum NumberSequenceKind {
  QUOTE
  INVOICE
}

model NumberSequence {
  id         BigInt            @id @default(autoincrement())
  businessId BigInt
  kind       NumberSequenceKind
  year       Int
  lastNumber Int
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, kind, year])
  @@index([businessId, kind, year])
}

model Quote {
  id              BigInt      @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  createdByUserId BigInt
  status          QuoteStatus @default(DRAFT)
  number          String?
  cancelledAt     DateTime?
  cancelReason    String?
  depositPercent  Int         @default(30)
  currency        String      @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  prestationsSnapshotText String?
  issuerSnapshotJson Json?
  clientSnapshotJson Json?
  issuedAt        DateTime?
  signedAt        DateTime?
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User    @relation("QuoteCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  billingProjects Project[] @relation("ProjectBillingQuote")
  items    QuoteItem[]
  invoice  Invoice? @relation("QuoteInvoice")

  @@unique([businessId, number])
}

model QuoteItem {
  id             BigInt   @id @default(autoincrement())
  quoteId        BigInt
  serviceId      BigInt?
  label          String
  description    String?
  discountType   DiscountType @default(NONE)
  discountValue  Int?
  originalUnitPriceCents BigInt?
  unitLabel      String?
  billingUnit    BillingUnit @default(ONE_OFF)
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

model Invoice {
  id              BigInt        @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  quoteId         BigInt?       @unique
  createdByUserId BigInt
  status          InvoiceStatus @default(DRAFT)
  number          String?
  depositPercent  Int           @default(30)
  currency        String        @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  prestationsSnapshotText String?
  issuerSnapshotJson Json?
  clientSnapshotJson Json?
  issuedAt        DateTime?
  dueAt           DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  quote    Quote?   @relation("QuoteInvoice", fields: [quoteId], references: [id], onDelete: SetNull)
  createdBy User    @relation("InvoiceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items    InvoiceItem[]
  reservation InventoryReservation?
  payments Payment[]
  subscriptionPeriod SubscriptionPeriod?

  @@unique([businessId, number])
}

model Payment {
  id         BigInt        @id @default(autoincrement())
  businessId BigInt
  invoiceId  BigInt
  projectId  BigInt?
  clientId   BigInt?
  createdByUserId BigInt?
  amountCents BigInt
  paidAt     DateTime
  method     PaymentMethod @default(WIRE)
  reference  String?
  note       String?
  deletedAt  DateTime?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoice  Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User?   @relation("PaymentCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, paidAt])
  @@index([invoiceId])
  @@index([projectId])
  @@index([clientId])
  @@index([businessId, deletedAt])
  @@index([createdByUserId])
}

model InvoiceItem {
  id             BigInt   @id @default(autoincrement())
  invoiceId      BigInt
  serviceId      BigInt?
  productId      BigInt?
  label          String
  description    String?
  discountType   DiscountType @default(NONE)
  discountValue  Int?
  originalUnitPriceCents BigInt?
  unitLabel      String?
  billingUnit    BillingUnit @default(ONE_OFF)
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([productId])
}

model BusinessDocument {
  id             BigInt       @id @default(autoincrement())
  businessId     BigInt
  clientId       BigInt?
  projectId      BigInt?
  title          String
  filename       String
  mimeType       String
  sizeBytes      Int
  storageKey     String       @unique
  sha256         String?
  kind           DocumentKind @default(FILE)
  createdByUserId BigInt
  createdAt      DateTime     @default(now())

  business  Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client    Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy User     @relation("DocumentCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([businessId, clientId, createdAt])
  @@index([businessId, projectId, createdAt])
  @@index([businessId, createdAt])
}

/**
 * ===================== MESSAGING =====================
 */

enum ConversationType {
  PRIVATE
  GROUP
}

model Conversation {
  id              BigInt           @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt?
  type            ConversationType
  name            String?
  createdByUserId BigInt
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  business  Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project   Project?              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy User                  @relation("ConversationCreatedBy", fields: [createdByUserId], references: [id])
  members   ConversationMember[]
  messages  Message[]

  @@index([businessId, projectId])
  @@index([projectId])
}

model ConversationMember {
  id             BigInt    @id @default(autoincrement())
  conversationId BigInt
  userId         BigInt
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             BigInt    @id @default(autoincrement())
  conversationId BigInt
  senderUserId   BigInt
  content        String?
  taskId         BigInt?
  taskGroupIds   String?
  createdAt      DateTime  @default(now())
  editedAt       DateTime?

  conversation Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User               @relation("MessageSender", fields: [senderUserId], references: [id])
  task         Task?              @relation(fields: [taskId], references: [id], onDelete: SetNull)
  attachments  MessageAttachment[]

  @@index([conversationId, createdAt])
  @@index([senderUserId])
}

model MessageAttachment {
  id         BigInt   @id @default(autoincrement())
  messageId  BigInt
  filename   String
  mimeType   String
  sizeBytes  Int
  storageKey String   @unique
  createdAt  DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

/**
 * ===================== WALLET (PERSONAL) =====================
 */

enum PersonalAccountType {
  CURRENT
  SAVINGS
  INVEST
  CASH
}

enum PersonalTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model PersonalAccount {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  type         PersonalAccountType @default(CURRENT)
  currency     String              @default("EUR")
  institution  String?
  iban         String?
  initialCents BigInt              @default(0)

  transactions PersonalTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model PersonalCategory {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  createdAt DateTime @default(now())

  // ✅ inverse relation
  transactions PersonalTransaction[]

  @@unique([userId, name])
}

model PersonalTransaction {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accountId BigInt
  account   PersonalAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  categoryId BigInt?
  category   PersonalCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  type        PersonalTransactionType
  date        DateTime
  amountCents BigInt
  currency    String                  @default("EUR")

  label String
  note  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
}
