generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/**
 * Rôles globaux de l'utilisateur (dans l'app entière)
 */
enum UserRole {
  USER
  ADMIN
}

/**
 * Rôles au niveau d'une entreprise
 */
enum BusinessRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum BusinessPermission {
  TEAM_EDIT
  FINANCE_EDIT
}

enum ProductUnit {
  PIECE
  KG
  HOUR
  LITER
  OTHER
}

enum InventoryMovementType {
  IN
  OUT
  ADJUST
}

enum InventoryReservationStatus {
  ACTIVE
  RELEASED
  CONSUMED
}

enum LedgerSourceType {
  INVENTORY_MOVEMENT
  INVOICE_STOCK_CONSUMPTION
  INVOICE_CASH_SALE
}

enum InventoryMovementSource {
  MANUAL
  PURCHASE
  SALE
}

/**
 * Statut d'une invitation d'entreprise
 */
enum BusinessInviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum LeadSource {
  UNKNOWN
  OUTBOUND
  INBOUND
  REFERRAL
  OTHER
}

enum ProspectStatus {
  NEW
  FOLLOW_UP
  WON
  LOST
}

enum QualificationLevel {
  COLD
  WARM
  HOT
}

enum ProspectPipelineStatus {
  NEW
  IN_DISCUSSION
  OFFER_SENT
  FOLLOW_UP
  CLOSED
}

enum ClientStatus {
  ACTIVE
  PAUSED
  FORMER
}

/**
 * Utilisateur de l'app
 */
model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Entreprises que l'utilisateur a créées
  ownedBusinesses     Business[]           @relation("BusinessOwner")
  // Entreprises auxquelles il appartient (via membership)
  businessMemberships BusinessMembership[]
  assignedTasks       Task[]
  quotesCreated       Quote[]   @relation("QuoteCreatedBy")
  invoicesCreated     Invoice[] @relation("InvoiceCreatedBy")

  // Wallet (perso)
  personalAccounts     PersonalAccount[]
  personalTransactions PersonalTransaction[]
  personalCategories   PersonalCategory[]
  interactionsCreated  Interaction[] @relation("InteractionCreatedBy")
  inventoryMovements   InventoryMovement[]
  ledgerEntriesCreated LedgerEntry[]
}

/**
 * Entreprise (espace PRO)
 */
model Business {
  id   BigInt @id @default(autoincrement())
  name String
  websiteUrl String?

  ownerId BigInt
  owner   User   @relation("BusinessOwner", fields: [ownerId], references: [id])

  memberships BusinessMembership[]
  invites     BusinessInvite[]
  prospects   Prospect[]
  clients     Client[]
  projects    Project[]
  tasks       Task[]
  finances    Finance[]
  services    Service[]
  interactions Interaction[]
  quotes      Quote[]
  invoices    Invoice[]
  references  BusinessReference[]
  processes   Process[]
  settings    BusinessSettings?
  products    Product[]
  inventoryMovements InventoryMovement[]
  inventoryReservations InventoryReservation[]
  ledgerEntries        LedgerEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * Lien utilisateur <-> entreprise, avec un rôle
 */
model BusinessMembership {
  id         BigInt       @id @default(autoincrement())
  businessId BigInt
  userId     BigInt
  role       BusinessRole

  business Business @relation(fields: [businessId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  employeeProfile EmployeeProfile?
  permissions     BusinessMemberPermission[]

  createdAt DateTime @default(now())

  @@unique([businessId, userId])
}

model EmployeeProfile {
  id           BigInt         @id @default(autoincrement())
  membershipId BigInt         @unique
  jobTitle     String?
  contractType String?
  startDate    DateTime?
  endDate      DateTime?
  weeklyHours  Int?
  hourlyCostCents BigInt?
  status       EmployeeStatus @default(ACTIVE)
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  membership BusinessMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
}

model BusinessMemberPermission {
  id           BigInt             @id @default(autoincrement())
  membershipId BigInt
  permission   BusinessPermission
  createdAt    DateTime           @default(now())

  membership BusinessMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permission])
  @@index([permission])
}

/**
 * Invitation pour rejoindre une entreprise
 */
model BusinessInvite {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  email      String
  role       BusinessRole
  status     BusinessInviteStatus @default(PENDING)
  token      String               @unique
  expiresAt  DateTime?
  createdAt  DateTime             @default(now())

  business Business @relation(fields: [businessId], references: [id])
}

model Prospect {
  id         BigInt   @id @default(autoincrement())
  businessId BigInt
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  name         String
  title        String?
  contactName  String?
  contactEmail String?
  contactPhone String?

  source             LeadSource?
  interestNote       String?
  qualificationLevel QualificationLevel?

  projectIdea     String?
  estimatedBudget Int?
  origin          String?
  probability     Int       @default(0)
  nextActionDate  DateTime?

  firstContactAt DateTime?
  pipelineStatus ProspectPipelineStatus @default(NEW)
  status          ProspectStatus        @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ProjectStatus {
  PLANNED
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ProjectQuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  SIGNED
}

enum ProjectDepositStatus {
  NOT_REQUIRED
  PENDING
  PAID
}

enum QuoteStatus {
  DRAFT
  SENT
  SIGNED
  CANCELLED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPhase {
  CADRAGE
  UX
  DESIGN
  DEV
  SEO
  LAUNCH
  FOLLOW_UP
}

enum FinanceType {
  INCOME
  EXPENSE
}

enum ProcessStatus {
  ACTIVE
  ARCHIVED
}

enum InteractionType {
  CALL
  MEETING
  EMAIL
  NOTE
  MESSAGE
}

enum BusinessReferenceType {
  CATEGORY
  TAG
  NUMBERING
  AUTOMATION
}

model Client {
  id              BigInt       @id @default(autoincrement())
  businessId      BigInt
  categoryReferenceId BigInt?
  name            String
  websiteUrl      String?
  companyName     String?
  mainContactName String?
  email           String?
  phone           String?
  address         String?
  sector          String?
  entryDate       DateTime?
  leadSource      LeadSource?
  needsType       String?
  estimatedBudget Int?
  notes           String?
  status          ClientStatus @default(ACTIVE)
  archivedAt      DateTime?

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  categoryReference BusinessReference? @relation("ClientCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tags       ClientTag[]
  projects Project[]
  interactions Interaction[]
  quotes    Quote[]
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, name])
  @@index([businessId, categoryReferenceId])
  @@index([businessId, archivedAt])
}

model Project {
  id         BigInt        @id @default(autoincrement())
  businessId BigInt
  clientId   BigInt?
  categoryReferenceId BigInt?
  name       String
  status     ProjectStatus @default(PLANNED)
  quoteStatus   ProjectQuoteStatus   @default(DRAFT)
  depositStatus ProjectDepositStatus @default(PENDING)
  startedAt     DateTime?
  archivedAt    DateTime?
  startDate  DateTime?
  endDate    DateTime?

  business Business @relation(fields: [businessId], references: [id])
  client   Client?  @relation(fields: [clientId], references: [id])
  categoryReference BusinessReference? @relation("ProjectCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tasks    Task[]
  finances Finance[]
  projectServices ProjectService[]
  interactions Interaction[]
  tags     ProjectTag[]
  quotes    Quote[]
  invoices  Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, categoryReferenceId])
}

model Task {
  id             BigInt      @id @default(autoincrement())
  businessId     BigInt
  projectId      BigInt?
  assigneeUserId BigInt?
  categoryReferenceId BigInt?
  title          String
  status         TaskStatus  @default(TODO)
  dueDate        DateTime?
  phase          TaskPhase?
  progress       Int         @default(0)
  completedAt    DateTime?
  notes          String?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  assignee User?    @relation(fields: [assigneeUserId], references: [id], onDelete: SetNull)
  categoryReference BusinessReference? @relation("TaskCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tags     TaskTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
  @@index([businessId, projectId])
  @@index([businessId, categoryReferenceId])
}

model Process {
  id          BigInt        @id @default(autoincrement())
  businessId  BigInt
  name        String
  description String?
  status      ProcessStatus @default(ACTIVE)

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  steps    ProcessStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
}

model ProcessStep {
  id          BigInt   @id @default(autoincrement())
  processId   BigInt
  title       String
  description String?
  position    Int
  isDone      Boolean  @default(false)

  process Process @relation(fields: [processId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([processId])
}

model Finance {
  id         BigInt      @id @default(autoincrement())
  businessId BigInt
  projectId  BigInt?
  categoryReferenceId BigInt?
  inventoryMovementId BigInt? @unique
  inventoryProductId  BigInt?
  type       FinanceType
  amountCents BigInt
  category   String
  date       DateTime
  note       String?

  business Business @relation(fields: [businessId], references: [id])
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  categoryReference BusinessReference? @relation("FinanceCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  inventoryMovement  InventoryMovement? @relation("InventoryMovementFinance", fields: [inventoryMovementId], references: [id], onDelete: SetNull)
  inventoryProduct   Product?           @relation("ProductFinance", fields: [inventoryProductId], references: [id], onDelete: SetNull)
  tags     FinanceTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, date])
  @@index([businessId, type])
  @@index([businessId, categoryReferenceId])
  @@index([businessId, inventoryProductId])
}

/**
 * Catalogue de services vendables
 */
model Service {
  id          BigInt   @id @default(autoincrement())
  businessId  BigInt
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  code        String   @unique
  name        String
  categoryReferenceId BigInt?
  type        String?
  description String?
  defaultPriceCents BigInt?
  tjmCents    BigInt?
  durationHours Int?
  vatRate     Int?

  categoryReference BusinessReference? @relation("ServiceCategoryReference", fields: [categoryReferenceId], references: [id], onDelete: SetNull)
  tags              ServiceTag[]
  taskTemplates   ServiceTaskTemplate[]
  projectServices ProjectService[]
  quoteItems      QuoteItem[]
  invoiceItems    InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, code])
  @@index([businessId, categoryReferenceId])
}

model Product {
  id                 BigInt       @id @default(autoincrement())
  businessId         BigInt
  business           Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  sku                String
  skuLower           String
  name               String
  description        String?
  unit               ProductUnit  @default(PIECE)
  salePriceCents     BigInt?
  purchasePriceCents BigInt?
  isArchived         Boolean      @default(false)
  movements          InventoryMovement[]
  inventoryFinances  Finance[]    @relation("ProductFinance")
  reservationItems   InventoryReservationItem[]
  invoiceItems       InvoiceItem[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@unique([businessId, skuLower])
  @@index([businessId, isArchived])
}

model InventoryMovement {
  id              BigInt                  @id @default(autoincrement())
  businessId      BigInt
  productId       BigInt
  type            InventoryMovementType
  source          InventoryMovementSource @default(MANUAL)
  quantity        Int
  unitCostCents   BigInt?
  reason          String?
  date            DateTime
  createdByUserId BigInt?
  financeEntry    Finance?                @relation("InventoryMovementFinance")

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdBy User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, productId])
  @@index([businessId, date])
}

model InventoryReservation {
  id         BigInt                    @id @default(autoincrement())
  businessId BigInt
  invoiceId  BigInt      @unique
  status     InventoryReservationStatus @default(ACTIVE)
  items      InventoryReservationItem[]

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, status])
}

model InventoryReservationItem {
  id             BigInt @id @default(autoincrement())
  reservationId  BigInt
  productId      BigInt
  quantity       Int
  unitPriceCents BigInt?
  createdAt      DateTime @default(now())

  reservation InventoryReservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  product     Product             @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([reservationId])
  @@index([productId])
}

model ProjectTag {
  id          BigInt @id @default(autoincrement())
  projectId   BigInt
  referenceId BigInt

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ProjectTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([projectId, referenceId])
  @@index([referenceId])
}

model ServiceTag {
  id          BigInt @id @default(autoincrement())
  serviceId   BigInt
  referenceId BigInt

  service   Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ServiceTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([serviceId, referenceId])
  @@index([referenceId])
}

model ServiceTaskTemplate {
  id        BigInt    @id @default(autoincrement())
  serviceId BigInt
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  phase     TaskPhase?
  title     String
  defaultAssigneeRole String?
  defaultDueOffsetDays Int?
  createdAt DateTime @default(now())
}

model ProjectService {
  id         BigInt   @id @default(autoincrement())
  projectId  BigInt
  serviceId  BigInt
  quantity   Int      @default(1)
  priceCents BigInt?
  notes      String?
  createdAt  DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([projectId, serviceId])
}

model Interaction {
  id        BigInt   @id @default(autoincrement())
  businessId BigInt
  clientId  BigInt?
  projectId BigInt?
  type      InteractionType
  content   String
  happenedAt DateTime
  nextActionDate DateTime?
  createdByUserId BigInt?
  createdAt DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project  Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdBy User?   @relation("InteractionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([businessId, clientId])
  @@index([businessId, projectId])
}

model BusinessReference {
  id         BigInt               @id @default(autoincrement())
  businessId BigInt
  type       BusinessReferenceType
  name       String
  value      String?
  isArchived Boolean              @default(false)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  projectCategories Project[] @relation("ProjectCategoryReference")
  serviceCategories Service[] @relation("ServiceCategoryReference")
  clientCategories  Client[]  @relation("ClientCategoryReference")
  taskCategories    Task[]    @relation("TaskCategoryReference")
  financeCategories Finance[] @relation("FinanceCategoryReference")
  projectTags       ProjectTag[] @relation("ProjectTagReference")
  serviceTags       ServiceTag[] @relation("ServiceTagReference")
  clientTags        ClientTag[] @relation("ClientTagReference")
  taskTags          TaskTag[] @relation("TaskTagReference")
  financeTags       FinanceTag[] @relation("FinanceTagReference")

  @@unique([businessId, type, name])
  @@index([businessId, type])
}

model ClientTag {
  id          BigInt @id @default(autoincrement())
  clientId    BigInt
  referenceId BigInt

  client    Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("ClientTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([clientId, referenceId])
  @@index([referenceId])
}

model TaskTag {
  id          BigInt @id @default(autoincrement())
  taskId      BigInt
  referenceId BigInt

  task      Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("TaskTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([taskId, referenceId])
  @@index([referenceId])
}

model FinanceTag {
  id          BigInt @id @default(autoincrement())
  financeId   BigInt
  referenceId BigInt

  finance   Finance          @relation(fields: [financeId], references: [id], onDelete: Cascade)
  reference BusinessReference @relation("FinanceTagReference", fields: [referenceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([financeId, referenceId])
  @@index([referenceId])
}

model LedgerEntry {
  id             BigInt          @id @default(autoincrement())
  businessId     BigInt
  date           DateTime
  memo           String?
  sourceType     LedgerSourceType
  sourceId       BigInt?
  createdByUserId BigInt?
  lines          LedgerLine[]

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdBy User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId, date])
  @@index([sourceType, sourceId])
  @@unique([sourceType, sourceId])
}

model LedgerLine {
  id          BigInt  @id @default(autoincrement())
  entryId     BigInt
  accountCode String
  accountName String?
  debitCents  BigInt?
  creditCents BigInt?
  metadata    Json?

  entry LedgerEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([entryId])
}

model BusinessSettings {
  id                     BigInt   @id @default(autoincrement())
  businessId             BigInt   @unique
  invoicePrefix          String   @default("INV-")
  quotePrefix            String   @default("DEV-")
  nextInvoiceNumber      Int      @default(1)
  nextQuoteNumber        Int      @default(1)
  defaultDepositPercent  Int      @default(30)
  paymentTermsDays       Int      @default(30)
  enableAutoNumbering    Boolean  @default(true)
  vatRatePercent         Int      @default(20)
  vatEnabled             Boolean  @default(false)
  allowMembersInvite     Boolean  @default(true)
  allowViewerExport      Boolean  @default(false)
  integrationStripeEnabled    Boolean  @default(false)
  integrationStripePublicKey  String?
  accountInventoryCode   String   @default("3700")
  accountCogsCode        String   @default("6000")
  accountCashCode        String   @default("5300")
  accountRevenueCode     String   @default("7000")
  ledgerSalesAccountCode       String   @default("706")
  ledgerVatCollectedAccountCode String   @default("44571")
  ledgerCashAccountCode        String   @default("512")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model Quote {
  id              BigInt      @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  createdByUserId BigInt
  status          QuoteStatus @default(DRAFT)
  number          String?
  depositPercent  Int         @default(30)
  currency        String      @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  issuedAt        DateTime?
  expiresAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  createdBy User    @relation("QuoteCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items    QuoteItem[]
  invoice  Invoice? @relation("QuoteInvoice")

  @@unique([businessId, number])
}

model QuoteItem {
  id             BigInt   @id @default(autoincrement())
  quoteId        BigInt
  serviceId      BigInt?
  label          String
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
}

model Invoice {
  id              BigInt        @id @default(autoincrement())
  businessId      BigInt
  projectId       BigInt
  clientId        BigInt?
  quoteId         BigInt?       @unique
  createdByUserId BigInt
  status          InvoiceStatus @default(DRAFT)
  number          String?
  depositPercent  Int           @default(30)
  currency        String        @default("EUR")
  totalCents      BigInt
  depositCents    BigInt
  balanceCents    BigInt
  note            String?
  issuedAt        DateTime?
  dueAt           DateTime?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  project  Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  client   Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  quote    Quote?   @relation("QuoteInvoice", fields: [quoteId], references: [id], onDelete: SetNull)
  createdBy User    @relation("InvoiceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  items    InvoiceItem[]
  reservation InventoryReservation?

  @@unique([businessId, number])
}

model InvoiceItem {
  id             BigInt   @id @default(autoincrement())
  invoiceId      BigInt
  serviceId      BigInt?
  productId      BigInt?
  label          String
  quantity       Int
  unitPriceCents BigInt
  totalCents     BigInt
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([productId])
}

/**
 * ===================== WALLET (PERSONAL) =====================
 */

enum PersonalAccountType {
  CURRENT
  SAVINGS
  INVEST
  CASH
}

enum PersonalTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model PersonalAccount {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  type         PersonalAccountType @default(CURRENT)
  currency     String              @default("EUR")
  institution  String?
  iban         String?
  initialCents BigInt              @default(0)

  transactions PersonalTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model PersonalCategory {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  createdAt DateTime @default(now())

  // ✅ inverse relation
  transactions PersonalTransaction[]

  @@unique([userId, name])
}

model PersonalTransaction {
  id     BigInt @id @default(autoincrement())
  userId BigInt
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accountId BigInt
  account   PersonalAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  categoryId BigInt?
  category   PersonalCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  type        PersonalTransactionType
  date        DateTime
  amountCents BigInt
  currency    String                  @default("EUR")

  label String
  note  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([accountId, date])
}
